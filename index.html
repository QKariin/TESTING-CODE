<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Task Dom üñ§ Slave UI</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;600;700&family=Rubik+Glitch&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body>

<!-- SOUND -->
<audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="coinSound" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
<audio id="skipSound" src="https://static.wixstatic.com/mp3/ce3e5b_3b5b34d4083847e2b123b6fd9a8551fd.mp3"></audio>
<audio id="sfx-buy" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
<audio id="sfx-deny" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

<div id="celebrationOverlay" style="position:fixed;inset:0;pointer-events:none;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;">
    <div class="glass-card" style="border: 2px solid var(--neon-green); text-align:center;">
        <div style="font-size:1.8rem;font-weight:900;color:var(--neon-green);text-shadow:0 0 20px var(--neon-green);">TASK<br>SUBMITTED</div>
    </div>
</div>

<svg style="display:none;">
    <symbol id="icon-coin" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.69 1.64 1.83 1.64 1.22 0 1.6-.64 1.6-1.26 0-.81-.42-1.22-2.34-1.67-2.37-.59-3.54-1.7-3.54-3.41 0-1.68 1.29-2.94 3.28-3.29V4h2.66v1.93c1.61.27 2.87 1.28 3.01 3.05h-1.95c-.14-.99-.68-1.55-1.7-1.55-1.04 0-1.55.56-1.55 1.15 0 .75.46 1.2 2.37 1.65 2.51.6 3.58 1.74 3.58 3.52 0 1.82-1.46 3.09-3.28 3.34z"/></symbol>
    <symbol id="icon-star" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></symbol>
    <symbol id="icon-send" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 17.59 13.41 12z"/></symbol>
    <symbol id="icon-timer" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></symbol>
</svg>

<input type="file" id="profileUploadInput" accept="image/*" class="hidden" onchange="handleProfileUpload(this)">

<div class="app-container">
    <div class="top-section-split">
        <div class="layout-left">
            <div class="glass-card profile-card">
                <div class="pc-avatar-section">
                    <div class="pc-avatar-box" onclick="document.getElementById('profileUploadInput').click()">
                        <img id="profilePic" src="" class="pc-avatar-img">
                        <div class="pc-avatar-edit-overlay"><span style="font-size:1.5rem; color:white;">‚úé</span></div>
                    </div>
                    <div class="pc-info-wrapper">
                        <div id="subName" class="pc-name">SLAVE</div>
                        <div id="subHierarchy" class="pc-rank">LOADING...</div>
                        <div class="level-progress-container">
                            <div class="lp-labels">
                                <span>NEXT: <span id="nextLevelName" style="color:white;">-</span></span>
                                <span id="pointsNeeded">0 to go</span>
                            </div>
                            <div class="lp-bar-bg"><div id="progressBar" class="lp-bar-fill"></div></div>
                        </div>
                        <div class="devotion-wrapper">
                          <div id="btn" class="kneel-btn-bar" onclick="handleClick()" style="position: relative; display: block;">
                              <span id="fill" class="bar-fill" style="display: block; position: absolute; top: 0; left: 0; height: 100%; z-index: 1;"></span> 
                              <div class="bar-text" style="position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; pointer-events: none;">
                                  <span id="txt-main" style="font-size: 0.85rem; font-weight: 900; color: grey;">KNEEL</span>
                                  <span id="txt-sub" style="font-size: 0.45rem; color: #888; font-family: 'Rajdhani';">TODAY KNEELING: 0</span>
                              </div>
                          </div>
                          <div class="daily-id-display">DAILY ID: <span id="dailyRandomId" class="did-val">#----</span></div>
                      </div>
                   </div>
                </div>
                <div class="pc-stats-grid">
                    <div class="stat-single-row row-score" style="display: flex; align-items: baseline; justify-content: center; gap: 8px;">
                        <div id="points" class="ssr-val">0</div>
                        <div class="ssr-lbl">POINTS</div>
                    </div>
                    <div class="stat-single-row row-coins" style="align-items: center; justify-content: center; gap: 8px;">
                        <div id="coins" class="ssr-val">0</div>
                        <svg style="width:20px; height:20px; fill:var(--neon-yellow); filter:drop-shadow(0 0 5px rgba(255, 215, 0, 0.6));"><use href="#icon-coin"></use></svg>
                    </div>
                </div>
                <div class="stats-toggle-btn" onclick="toggleStats()">STATS ‚ñæ</div>
                <div id="statsContent">
                  <div class="stat-row-group">
                      <div class="stat-header" style="text-align: center;">SLAVE'S ACTIVITY</div>
                      <div class="stat-line"><span>Task Streak</span> <strong id="statStreak">0</strong></div>
                      <div class="stat-line"><span>Total Tasks</span> <strong id="statTotal">0</strong></div>
                      <div class="stat-line"><span>Completed</span> <strong id="statCompleted">0</strong></div>
                      <div class="stat-line"><span>Skipped</span> <strong id="statSkipped">0</strong></div>
                      <div class="stat-line"><span>Total Kneeling</span> <strong id="statTotalKneels">0</strong></div>
                      <div style="text-align: center; border-top: 1px solid #333; margin-top: 10px; padding-top: 10px; display: flex; flex-direction: column; align-items: center;">
                          <div class="stat-header" style="border:none; margin:0; padding:0; font-size: 0.65rem;">SLAVE SINCE</div>
                          <strong id="slaveSinceDate" style="font-size: 0.85rem; color: white; display: block; margin-top: 2px;">--/--/--</strong>
                      </div>
                  </div>
              </div>
            </div>
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('serve')">HOME</button>
                <button class="tab-btn nav-togglable" onclick="switchTab('news')">QKARIN</button>
                <button class="tab-btn nav-togglable" onclick="switchTab('tribute')">TRIBUTE</button>
                <button id="nav-btn-session" class="tab-btn nav-togglable" onclick="switchTab('session')">BUY SESSION</button>
                <button class="tab-btn nav-togglable" onclick="switchTab('rewards')">REWARDS</button>
                <button class="tab-btn nav-togglable" onclick="switchTab('protocol')">PROTOCOL</button>
                <button class="tab-btn btn-foot-bank nav-togglable" onclick="switchTab('buy')">BUY COINS</button>
            </div>
        </div>

        <div class="layout-right">
            <div id="viewServingTop" style="display:flex; flex-direction:column; gap:15px;">
                <div id="taskCard" class="glass-card">
                    <div id="activeBadge">ACTIVE TASK</div>
                    <div id="taskContent" style="width: 100%; padding: 10px 0; text-align: center; flex-grow: 1; display:flex; flex-direction:column; justify-content:center;">
                        <h2 id="readyText" style="font-weight:bold; margin-bottom:5px; color:white; font-size:1.5rem;">Ready?</h2>
                        <p class="rajdhani" style="color:#aaa; margin:0;">Waiting for orders.</p>
                    </div>
                    <div id="cooldownSection" class="hidden" style="width: 100%; display:flex; flex-direction:column; align-items:center; text-align:center; padding-bottom: 10px;">
                        <div id="timerDisplay" style="font-size:2rem; font-weight:bold; margin:5px 0; color:white; text-shadow: 0 0 10px rgba(255,255,255,0.3);">24:00:00</div>
                        <input type="file" id="evidenceInput" accept="image/*,video/*" class="hidden" onchange="handleEvidenceUpload(this)">
                        <button onclick="document.getElementById('evidenceInput').click()" class="action-btn btn-upload">UPLOAD PROOF</button>
                        <button onclick="cancelPendingTask()" id="btnSkip" style="background:transparent; border:none; color:#ddd; margin-top:10px; font-size:0.7rem; cursor:pointer; text-transform:uppercase;">Skip / Cancel</button>
                        <div id="uploadStatus" style="height:15px; font-size:0.7rem; color:#888; margin-top:5px;"></div>
                    </div>
                    <div id="mainButtonsArea" style="width:100%; margin-top:auto;">
                        <button id="newTaskBtn" onclick="getRandomTask()" class="action-btn" style="width: 50%; margin: 0 auto; display: block;">REQUEST TASK</button>
                    </div>
                </div>

                <div id="chatCard" class="glass-card">
                    <div id="chatBadge">CHAT</div>
                    <div id="sessionOverlay">
                        <div onclick="closeSessionUI()" style="position:absolute; top:15px; right:15px; color:var(--neon-green); font-size:1.5rem; font-weight:bold; cursor:pointer; line-height:1; z-index:100;">√ó</div>
                        <div style="padding: 20px; color: white; width: 100%; max-width: 400px; text-align: center;">
                            <h2 style="font-family:'Rubik Glitch'; font-size: 2rem; color: var(--neon-pink); margin-bottom: 20px;">REQUEST SESSION</h2>
                            <div style="margin-bottom: 20px; text-align: left;">
                                <label style="display:block; margin-bottom:10px; font-weight:bold; color:#ccc; font-size: 0.7rem; letter-spacing: 1px;">SESSION TYPE</label>
                                <div class="session-opt-group">
                                    <label class="session-radio-label">
                                        <input type="radio" name="sessionType" value="chat" data-cost="3000" class="session-radio-input" onchange="updateSessionCost()" checked>
                                        <span class="s-lbl-title">CHAT</span><span class="s-lbl-cost">3000 ü™ô</span>
                                    </label>
                                    <label class="session-radio-label">
                                        <input type="radio" name="sessionType" value="video" data-cost="5000" class="session-radio-input" onchange="updateSessionCost()">
                                        <span class="s-lbl-title">VIDEO</span><span class="s-lbl-cost">5000 ü™ô</span>
                                    </label>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px; text-align: left;">
                                <label style="display:block; margin-bottom:10px; font-weight:bold; color:#ccc; font-size: 0.7rem; letter-spacing: 1px;">FOCUS / KINK</label>
                                <select id="sessionFocus" style="width:100%; background:#111; border:1px solid #444; color:white; padding:10px; border-radius:8px; font-family:'Rajdhani'; outline:none;">
                                    <option value="JEI">JEI</option><option value="CEI">CEI</option><option value="SPH">SPH</option><option value="HUMILIATION">HUMILIATION</option><option value="EXPOSING">EXPOSING</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 20px; text-align: left;">
                                <label style="display:block; margin-bottom:10px; font-weight:bold; color:#ccc; font-size: 0.7rem; letter-spacing: 1px;">TIME (TODAY)</label>
                                <select id="sessionTimeSelect" style="width:100%; background:#111; border:1px solid #444; color:white; padding:10px; border-radius:8px; font-family:'Rajdhani'; outline:none;">
                                    <option value="NOW">Now (Within 10m)</option><option value="30MIN">In 30 Minutes</option><option value="1HOUR">In 1 Hour</option><option value="3HOURS">In 3 Hours</option><option value="6HOURS">In 6 Hours</option><option value="LATER">Later Today (Discuss in Chat)</option>
                                </select>
                            </div>
                            <div style="margin-top: 30px;">
                                <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">HOLD AMOUNT: <span id="sessionCostDisplay" style="color:var(--neon-yellow); font-weight:bold;">3000</span> ü™ô</div>
                                <div style="display:flex; gap: 10px;">
                                    <button onclick="submitSessionRequest()" class="action-btn" style="background:var(--neon-pink); border:none; width:100%;">CONFIRM REQUEST</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="specialGlassOverlay" onclick="breakGlass(event)" ontouchstart="breakGlass(event)">
                        <img src="https://static.wixstatic.com/media/ce3e5b_b75c0e95797b4ba8abe4198a83b6c9ae~mv2.gif" class="broken-glass-img">
                    </div>
                    <div class="chat-header-row">
                        <div class="chat-avatar-container">
                            <div id="chatStatusRing" class="dom-status-ring ring-inactive"></div>
                            <img src="https://static.wixstatic.com/media/ce3e5b_1bd27ba758ce465fa89a36d70a68f355~mv2.png" class="chat-header-img">
                        </div>
                        <div class="chat-header-info">
                            <div class="chat-header-title">QUEEN KARIN</div>
                            <div id="chatStatusBadge" class="chat-status-text">LAST SEEN: TODAY</div>
                        </div>
                        <button id="chatSessionBtn" onclick="openSessionUI()"><span>üìÖ</span> REQUEST SESSION</button>
                    </div>
                    <div class="chat-area" id="chatBox">
                        <button id="chatLoadMoreBtn" onclick="loadMoreChat()" style="display:none; width: 100%; background: transparent; color: #666; font-size: 0.7rem; border: none; padding: 5px; cursor: pointer; text-transform: uppercase; margin-bottom: 10px;">‚ñ≤ Load Older Messages</button>
                        <div id="chatContent"></div>
                    </div>
                    <div class="coin-presets-row">
                        <button class="coin-btn" onclick="sendCoins(500)">500 <svg style="width:12px;height:12px;"><use href="#icon-coin"></use></svg></button>
                        <button class="coin-btn" onclick="sendCoins(1000)">1000 <svg style="width:12px;height:12px;"><use href="#icon-coin"></use></svg></button>
                        <button class="coin-btn" onclick="sendCoins(2000)">2000 <svg style="width:12px;height:12px;"><use href="#icon-coin"></use></svg></button>
                        <button class="coin-btn" onclick="sendCoins(5000)">5000 <svg style="width:12px;height:12px;"><use href="#icon-coin"></use></svg></button>
                    </div>
                    <div class="chat-input-row">
                        <input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden-input" onchange="handleAdminUpload(this)">
                        <button class="btn-plus" onclick="document.getElementById('adminMediaInput').click()">+</button>
                        <input type="text" id="chatMsgInput" class="chat-input" placeholder="Message..." onkeypress="handleChatKey(event)">
                        <button class="chat-send" onclick="sendChatMessage()"><svg style="width:20px; height:20px; fill:black;"><use href="#icon-send"></use></svg></button>
                    </div>
                    <div id="chatMediaOverlay" onclick="closeChatPreview()" style="display:none; position:absolute; top:60px; bottom:70px; left:0; right:0; background:rgba(0,0,0,0.95); z-index:80; backdrop-filter:blur(5px); flex-direction:column; align-items:center; justify-content:center;">
                        <div style="position:absolute; top:10px; right:10px; color:white; font-size:2rem; font-weight:bold; cursor:pointer; z-index:90; padding:10px;">√ó</div>
                        <div id="cmoContent" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: QKARIN FEED -->
            <div id="viewNews" class="hidden">
                <div class="glass-card" style="height: 100%; padding:0; overflow:hidden; background:#000;">
                    <div class="social-header">
                        <div class="sh-avatar-frame"><img src="https://static.wixstatic.com/media/ce3e5b_1bd27ba758ce465fa89a36d70a68f355~mv2.png" class="sh-avatar"></div>
                        <div class="sh-info">
                            <div class="sh-name">QUEEN KARIN</div>
                            <div class="sh-bio">Time to serve.</div>
                            <div class="sh-stats">
                                <div class="sh-stat-item"><span class="sh-val" id="cntPosts">0</span><span class="sh-lbl">POSTS</span></div>
                                <div class="sh-stat-item"><span class="sh-val">‚àû</span><span class="sh-lbl">OWNER</span></div>
                                <div id="domStatusBadge" class="sh-stat-item"><span class="sh-val" style="color:var(--neon-green)">ONLINE</span><span class="sh-lbl">STATUS</span></div>
                            </div>
                        </div>
                    </div>
                    <div id="domVideoReel" class="highlights-rail"></div>
                    <div class="feed-nav"><div class="fn-btn active">GRID</div></div>
                    <div id="newsGrid" class="social-grid"></div>
                </div>
            </div>

            <!-- VIEW: TRIBUTE -->
            <div id="viewTribute" class="hidden">
                <div class="glass-card">
                    <h2 style="text-align:center; color:white; font-family:'Rubik Glitch'; font-size:2rem; margin-bottom:15px;">THE STORE</h2>
                    <div class="cat-scroll">
                        <div class="cat-pill active" onclick="filterStore('all', this)">ALL</div>
                        <div class="cat-pill" onclick="filterStore('little', this)">LITTLE</div>
                        <div class="cat-pill" onclick="filterStore('middle', this)">MIDDLE</div>
                        <div class="cat-pill" onclick="filterStore('big', this)">BIG</div>
                        <div class="cat-pill" onclick="filterStore('naughty', this)">NAUGHTY</div>
                        <div class="cat-pill" onclick="filterStore('freedom', this)">FREEDOM</div>
                    </div>
                    <div id="storeGrid" class="store-grid"></div>
                </div>
            </div>
            
            <div id="viewSession" class="hidden">
                <div class="glass-card" style="text-align:center; padding: 50px;">
                    <h2 style="font-size:2rem; color:var(--neon-pink); text-shadow:0 0 10px var(--neon-pink);">PRIVATE SESSIONS</h2>
                    <p style="color:#aaa; font-family:'Rajdhani'; margin-top:10px;">Currently offline. Check back later.</p>
                </div>
            </div>
            
            <div id="viewProtocol" class="hidden">
                <div class="glass-card">
                    <h2 style="text-align:center; color:white; font-family:'Orbitron'; font-size:1.8rem; margin-bottom:20px; letter-spacing:2px;">OPERATIONAL PROTOCOL</h2>
                    <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
                        <div class="protocol-item" onclick="toggleSection(this)" style="border:1px solid var(--neon-yellow);">
                            <h3 class="protocol-header" style="color:var(--neon-yellow);">THE ECONOMY<span class="protocol-arrow">‚ñº</span></h3>
                            <div class="protocol-content">
                                <p><strong>COINS:</strong> Used for wishlist and tasks.</p>
                                <p><strong>POINTS:</strong> Earned via duties and rank.</p>
                            </div>
                        </div>
                        <!-- ... Protocol rules map to rule1-rule8 IDs ... -->
                        <div id="r1">Loading...</div><div id="r2"></div><div id="r3"></div><div id="r4"></div><div id="r5"></div><div id="r6"></div><div id="r7"></div><div id="r8"></div>
                    </div>
                </div>
            </div>

            <div id="viewRewards" class="hidden"><div class="glass-card"><h2>REWARDS</h2><div style="font-size: 3rem;">üéÅ</div></div></div>

            <div id="viewHierarchy" class="hidden">
                <div class="glass-card">
                    <div class="text-center mb-4"><h1 class="accent text-2xl md:text-4xl font-bold">ROYAL HIERARCHY</h1></div>
                    <div class="grid gap-4" id="hierarchyGrid"></div>
                </div>
            </div>

            <div id="viewBuy" class="hidden">
                <div class="glass-card">
                    <h2 style="text-align:center; color:var(--neon-yellow); font-family:'Rubik Glitch'; font-size:2rem;">BUY COINS</h2>
                    <div id="buyGrid" class="store-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- EVIDENCE LOG -->
    <div style="display:flex; align-items:center; gap:8px; margin-top:40px; margin-bottom:10px; font-size:0.8rem; color:#fff; font-weight:bold;">
        <div style="width:6px; height:6px; background:var(--neon-yellow); border-radius:50%;"></div> EVIDENCE LOG
    </div>

    <div id="pendingSection" style="display:none; width:100%;">
        <div class="section-header">PENDING REVIEW</div>
        <div id="pendingGrid" class="pending-grid"></div>
    </div>

    <div id="historySection">
        <div class="section-header">HISTORY</div>
        
        <!-- THE TRAPPED MODAL -->
        <div id="glassModal" class="glass-modal" onclick="closeModal(event)">
            <div id="modalMediaContainer" class="modal-bg-photo"></div>
            
            <div id="reviewCard" class="review-details-card">
                <div id="modalStatus" class="m-status-badge-big">APPROVED</div>
                <div class="m-reward-row">
                    <div id="modalPoints" class="m-points-val">+0 PTS</div>
                    <div id="modalSticker"></div>
                </div>
                <div id="feedbackRow" class="q-feedback-split">
                    <div class="q-thumb-box" onclick="toggleHistoryView('queen_media', event)">
                        <div id="modalFeedbackMedia" class="q-thumb-fill"></div>
                        <div class="q-zoom-hint">üîç</div>
                    </div>
                    <div class="q-nav-stack">
                        <div class="q-label">QUEEN'S FEEDBACK</div>
                        <button class="q-nav-btn" onclick="toggleHistoryView('comment', event)">SEE COMMENT</button>
                        <button class="q-nav-btn" onclick="toggleHistoryView('queen_media', event)">SEE PHOTO</button>
                    </div>
                </div>
                <div id="modalFeedbackText" class="q-comment-area hidden"></div>
            </div>

            <div id="modalOrderText" class="order-overlay-centered hidden"></div>

            <div class="modal-footer-nav">
                <button onclick="toggleHistoryView('task', event)" class="nav-btn">SEE TASK</button>
                <button onclick="toggleHistoryView('proof', event)" class="nav-btn">SEE PROOF</button>
                <button onclick="toggleHistoryView('info', event)" class="nav-btn">SEE STATUS</button>
                <button onclick="closeModal()" class="nav-btn btn-close">CLOSE</button>
            </div>
        </div>

        <div id="historyGrid" class="gallery-grid"></div>
        <button id="loadMoreBtn" onclick="loadMoreHistory()" class="action-btn" style="width: 200px; margin: 20px auto; display: none; background: #222; color: #888;">LOAD MORE</button>
    </div>
</div>

<script>
    /* --- CONFIG & STATE --- */
    const CLOUD_NAME = 'dfqvezjlj'; 
    const ACCOUNT_ID = 'kW2K8hR';
    const API_KEY = 'public_kW2K8hR6YbQXStTvMf5ZDYbVf1fQ';
    const QUEEN_AVATAR = "https://static.wixstatic.com/media/ce3e5b_1bd27ba758ce465fa89a36d70a68f355~mv2.png";
    const TWITCH_CHANNEL = "qkarin";

    let gameStats = { points: 0, coins: 0, kneelCount: 0, taskdom_streak: 0, taskdom_total_tasks: 0, taskdom_completed_tasks: 0 };
    let userProfile = { name: "Slave", hierarchy: "Loading...", joined: "" };
    let taskDatabase = []; 
    let galleryData = []; 
    let activeHistoryItem = null;
    let currentHistoryIndex = 0;
    let lastWorshipTime = 0;
    let isLocked = false;
    let lastNotifiedMessageId = null;
    let isInitialLoad = true;
    let historyLimit = 12;

    const CMS_HIERARCHY = [
        { Title: "Hall Boy", Icon: "üßπ", Order: 1, Points: "0+", Description: "Entry level of service.", StatusText: "First line of service.", ProtocolText: "Perform basic tasks.", DutiesText: "Prove you live to serve.", ContactText: "15MIN DAILY SLOT", CssClass: "" },
        { Title: "Footman", Icon: "üö∂‚Äç‚ôÇÔ∏è", Order: 2, Points: "2000+", Description: "Learn to serve.", StatusText: "Time to earn your place.", ProtocolText: "Serve quickly and reliably.", DutiesText: "Perfect Timing.", ContactText: "30MIN DAILY SLOT", CssClass: "" },
        { Title: "Silverman", Icon: "üç¥", Order: 3, Points: "5000+", Description: "Dedicated submissive.", StatusText: "Skilled and polished sub.", ProtocolText: "Focus on improvement.", DutiesText: "Face all challenges.", ContactText: "30MIN DAILY SLOT", CssClass: "" },
        { Title: "Butler", Icon: "üç∑", Order: 4, Points: "10000+", Description: "Trusted submissive.", StatusText: "Mastered consistency.", ProtocolText: "Notice needs without being told.", DutiesText: "Devotion is foundation.", ContactText: "DAILY 2x30min SLOTS", CssClass: "" },
        { Title: "Chamberlain", Icon: "üè∞", Order: 5, Points: "20000+", Description: "Senior submissive.", StatusText: "Act with excellence.", ProtocolText: "Carry yourself with dignity.", DutiesText: "Uphold standards.", ContactText: "UNLIMITED", CssClass: "Secretary" },
        { Title: "Secretary", Icon: "üìú", Order: 6, Points: "50000+", Description: "Worthy of trust.", StatusText: "Inner Circle.", ProtocolText: "Respect and safeguard.", DutiesText: "Authority on smaller matters.", ContactText: "UNLIMITED", CssClass: "elite-butler" },
        { Title: "Queen's Champion", Icon: "‚öîÔ∏è", Order: 7, Points: "100000", Description: "Ultimate submissive!", StatusText: "You have made it!", ProtocolText: "2 bodies, 1 soul!", DutiesText: "Enjoy the love you earned.", ContactText: "LEGENDARY", CssClass: "legendary" }
    ];

    const LEVELS = [{name: "HallBoy", min: 0}, {name: "Footman", min: 2000}, {name: "Silverman", min: 5000}, {name: "Butler", min: 10000}, {name: "Chamberlain", min: 20000}, {name: "Secretary", min: 50000}, {name: "Queen's Champion", min: 100000}];

    /* --- AUDIO UNLOCKER --- */
    let audioUnlocked = false;
    document.addEventListener('click', () => {
        if (!audioUnlocked) {
            ['msgSound', 'coinSound', 'skipSound'].forEach(id => {
                const s = document.getElementById(id);
                if (s) { s.play().then(() => { s.pause(); s.currentTime = 0; }); }
            });
            audioUnlocked = true;
        }
    }, { once: true });

    /* --- MASTER MESSAGE LISTENER --- */
    window.addEventListener("message", (event) => {
        const data = event.data;
        if (!data) return;

        // 1. DATA PACKET (Profile, History, Timer)
        if (data.type === "UPDATE_FULL_DATA" || data.profile) {
            const p = data.profile;
            if (p) {
                // Map Stats & Identity
                gameStats = { ...gameStats, ...p }; 
                userProfile.name = p.name || p.title || userProfile.name;
                userProfile.hierarchy = p.hierarchy || userProfile.hierarchy;
                userProfile.joined = p.joined || userProfile.joined;
                if (p.lastWorship) lastWorshipTime = new Date(p.lastWorship).getTime();
                
                if (p.profilePicture) {
                    const picEl = document.getElementById('profilePic');
                    if (picEl) picEl.src = getOptimizedUrl(p.profilePicture, 150);
                }
                updateStats();
            }
            if (data.galleryData) {
                galleryData = Array.isArray(data.galleryData) ? data.galleryData : JSON.parse(data.galleryData);
                renderGallery();
            }
            if (data.pendingState) {
                pendingTaskState = data.pendingState;
                if (pendingTaskState.task) { currentTask = pendingTaskState.task; restorePendingUI(); }
            }
        }

        // 2. CHAT ECHO
        if (data.type === "CHAT_ECHO") {
            const chatBox = document.getElementById('chatContent');
            if (chatBox && data.msgObj) {
                const isMe = (data.msgObj.sender === 'user');
                const rowClass = isMe ? 'mr-out' : 'mr-in';
                const msgClass = isMe ? 'm-slave' : 'm-queen';
                chatBox.innerHTML += `<div class="msg-row ${rowClass}"><div class="msg ${msgClass}">${data.msgObj.message}</div></div>`;
                document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            }
        }

        // 3. CHAT HISTORY
        if (data.type === "UPDATE_CHAT" || data.chatHistory) {
            const messages = data.chatHistory || data.messages;
            if (messages) {
                document.getElementById('chatContent').innerHTML = messages.map(m => {
                    const isMe = m.sender === 'user';
                    return `<div class="msg-row ${isMe?'mr-out':'mr-in'}"><div class="msg ${isMe?'m-slave':'m-queen'}">${m.message}</div></div>`;
                }).join('');
                if (!isInitialLoad) {
                    const last = messages[messages.length-1];
                    if (last._id !== lastNotifiedMessageId && last.sender !== 'user') { triggerSound('msgSound'); lastNotifiedMessageId = last._id; }
                }
                isInitialLoad = false;
                document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            }
        }

        // 4. CMS UPDATES (Rules, Feed, Tasks)
        if (data.type === 'UPDATE_RULES') {
            for (let i=1; i<=8; i++) { if(data.payload['rule'+i]) document.getElementById('r'+i).innerHTML = data.payload['rule'+i]; }
        }
        if (data.type === "UPDATE_DOM_STATUS") {
            const badge = document.getElementById('chatStatusBadge');
            if(badge) { badge.innerHTML = data.online ? "ONLINE" : data.text; badge.className = data.online ? "chat-status-text chat-online" : "chat-status-text"; }
        }
        if (data.type === "UPDATE_Q_FEED") { renderDomVideos(data.domVideos); renderNews(data.domVideos); }
        if (data.type === "INIT_TASKS") { taskDatabase = data.tasks; }
        if (data.type === "INIT_WISHLIST") { WISHLIST_ITEMS = data.wishlist; renderWishlist('all'); }
    });

    /* --- UI LOGIC --- */
    function updateStats() {
        document.getElementById('subName').innerText = userProfile.name;
        document.getElementById('subHierarchy').innerText = userProfile.hierarchy;
        document.getElementById('points').innerText = gameStats.points || gameStats.score || 0;
        document.getElementById('coins').innerText = gameStats.coins || gameStats.wallet || 0;
        
        if(document.getElementById('statStreak')) document.getElementById('statStreak').innerText = gameStats.taskdom_streak || 0;
        if(document.getElementById('statTotal')) document.getElementById('statTotal').innerText = gameStats.taskdom_total_tasks || 0;
        if(document.getElementById('statCompleted')) document.getElementById('statCompleted').innerText = gameStats.taskdom_completed_tasks || 0;
        if(document.getElementById('statTotalKneels')) document.getElementById('statTotalKneels').innerText = gameStats.kneelCount || 0;
        
        document.getElementById('txt-sub').innerText = `TODAY KNEELING: ${gameStats.kneelCount || 0}`;
        
        let nextLevel = LEVELS.find(l => l.min > (gameStats.points || gameStats.score)) || {name: "MAX", min: 0};
        document.getElementById('nextLevelName').innerText = nextLevel.name;
        
        updateDevotionStatus();
    }

    function switchTab(mode) {
        currentView = mode;
        const views = ['viewServingTop','viewTribute','viewSession','viewRewards','viewHierarchy','viewNews','viewProtocol','viewBuy'];
        views.forEach(v => { const el = document.getElementById(v); if(el) el.classList.add('hidden'); });
        const target = 'view' + mode.charAt(0).toUpperCase() + mode.slice(1);
        if(mode === 'serve') document.getElementById('viewServingTop').classList.remove('hidden');
        else if(document.getElementById(target)) document.getElementById(target).classList.remove('hidden');
        
        if(mode === 'hierarchy') renderHierarchy(CMS_HIERARCHY);
        if(mode === 'news') window.parent.postMessage({ type: "LOAD_Q_FEED" }, "*");
    }

    /* --- HISTORY & GALLERY --- */
    function renderGallery() {
        const hGrid = document.getElementById('historyGrid');
        const pGrid = document.getElementById('pendingGrid');
        const hItems = galleryData.filter(i => i.status && i.status.toLowerCase() !== 'pending');
        const pItems = galleryData.filter(i => i.status && i.status.toLowerCase() === 'pending');

        hGrid.innerHTML = hItems.map(item => `
            <div class="gallery-item" onclick="openHistoryModal(${galleryData.indexOf(item)})" style="position:relative; aspect-ratio:1; background:#000; border-radius:8px; overflow:hidden; border:1px solid #333;">
                <img src="${item.proofUrl}" style="width:100%; height:100%; object-fit:cover; opacity:0.6;">
                <div style="position:absolute; bottom:5px; left:5px; font-size:0.5rem; background:rgba(0,0,0,0.8); padding:2px 5px; border-radius:3px;">${item.status.toUpperCase()}</div>
            </div>`).join('');
            
        pGrid.innerHTML = pItems.map(item => `
            <div onclick="openHistoryModal(${galleryData.indexOf(item)})" style="aspect-ratio:1.5; background:#111; border-radius:10px; overflow:hidden; position:relative; border:1px solid var(--neon-yellow);">
                <img src="${item.proofUrl}" style="width:100%; height:100%; object-fit:cover; opacity:0.4;">
                <div style="position:absolute; bottom:10px; left:10px; font-weight:bold; font-size:0.7rem; color:var(--neon-yellow);">PENDING REVIEW</div>
            </div>`).join('');
        document.getElementById('pendingSection').style.display = pItems.length > 0 ? 'block' : 'none';
    }

    function openHistoryModal(index) {
        const item = galleryData[index];
        if(!item) return;
        activeHistoryItem = item;
        currentHistoryIndex = index;
        setMediaLayer(item.proofUrl);
        
        const statusEl = document.getElementById('modalStatus');
        const s = item.status.toUpperCase();
        statusEl.innerText = s;
        statusEl.style.color = s.includes('APP') ? 'var(--neon-green)' : (s.includes('PEND') ? 'var(--neon-yellow)' : 'var(--neon-red)');
        
        document.getElementById('modalPoints').innerText = `+${item.points || item.score || 0} PTS`;
        document.getElementById('modalSticker').innerHTML = item.sticker ? `<img src="${item.sticker}" style="width:60px; filter:drop-shadow(0 0 10px white);">` : "";
        
        const fMedia = document.getElementById('modalFeedbackMedia');
        const feedbackRow = document.getElementById('feedbackRow');
        if (item.adminMedia) {
            feedbackRow.style.display = "flex";
            const isVid = item.adminMedia.match(/\.(mp4|webm|mov)$/i);
            fMedia.innerHTML = isVid ? `<video src="${item.adminMedia}"></video>` : `<img src="${item.adminMedia}">`;
        } else { feedbackRow.style.display = "none"; }
        
        document.getElementById('modalFeedbackText').innerText = item.adminComment || "No comment.";
        document.getElementById('modalOrderText').innerText = item.text || "No details.";
        
        toggleHistoryView('info');
        document.getElementById('glassModal').classList.add('active');
    }

    function toggleHistoryView(view, event) {
        if(event) event.stopPropagation();
        const card = document.getElementById('reviewCard');
        const order = document.getElementById('modalOrderText');
        const text = document.getElementById('modalFeedbackText');
        card.classList.add('hidden'); order.classList.add('hidden'); text.classList.add('hidden');
        
        if(view === 'info'){ card.classList.remove('hidden'); setMediaLayer(activeHistoryItem.proofUrl); }
        else if(view === 'task'){ order.classList.remove('hidden'); }
        else if(view === 'comment'){ card.classList.remove('hidden'); text.classList.remove('hidden'); }
        else if(view === 'queen_media'){ setMediaLayer(activeHistoryItem.adminMedia); }
        else if(view === 'proof'){ setMediaLayer(activeHistoryItem.proofUrl); }
    }

    function setMediaLayer(url) {
        const container = document.getElementById('modalMediaContainer');
        if(!url) return;
        const isVid = url.match(/\.(mp4|webm|mov)$/i);
        container.innerHTML = isVid ? `<video src="${url}" autoplay loop muted></video>` : `<img src="${url}">`;
    }

    /* --- HELPERS --- */
    function closeModal() { document.getElementById('glassModal').classList.remove('active'); }
    function triggerSound(id) { const s = document.getElementById(id); if(s){ s.currentTime=0; s.play().catch(()=>{}); } }
    function getOptimizedUrl(url, w) { return url; } // Logic from original preserved
    function updateDevotionStatus() {
        const now = Date.now();
        const diff = now - lastWorshipTime;
        const cooldown = 60 * 60 * 1000;
        const fill = document.getElementById('fill');
        if(lastWorshipTime > 0 && diff < cooldown) {
            isLocked = true;
            const mins = Math.ceil((cooldown - diff) / 60000);
            document.getElementById('txt-main').innerText = `WAIT ${mins}m`;
            fill.style.width = (100 - (diff/cooldown*100)) + "%";
        } else {
            isLocked = false;
            document.getElementById('txt-main').innerText = "KNEEL";
            fill.style.width = "0%";
        }
    }
    function handleClick() {
        if(isLocked) return;
        triggerSound('coinSound');
        document.getElementById('fill').style.width = "100%";
        document.getElementById('txt-main').innerText = "PROCESSING...";
        window.parent.postMessage({ type: "WORSHIP" }, "*");
        isLocked = true;
    }
    function getRandomTask() {
        const t = taskDatabase[Math.floor(Math.random()*taskDatabase.length)];
        document.getElementById('taskContent').innerHTML = `<h3>${t}</h3>`;
        document.getElementById('cooldownSection').classList.remove('hidden');
        document.getElementById('mainButtonsArea').classList.add('hidden');
        currentTask = { text: t };
    }
    function sendChatMessage() {
        const input = document.getElementById('chatMsgInput');
        if(!input.value.trim()) return;
        window.parent.postMessage({ type: "SEND_CHAT_TO_BACKEND", text: input.value }, "*");
        input.value = "";
    }
    function handleChatKey(e) { if(e.key==='Enter') sendChatMessage(); }

    window.onload = () => { window.parent.postMessage({ type: "UI_READY" }, "*"); };
</script>
</body>
</html>
