<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Command Console</title>
  
  <!-- LOGIC IMPORTS -->
  <script type="module" src="../js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <!-- FONTS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@200;300;400;600&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet" />

  <!-- CSS LINKS -->
  <link rel="stylesheet" href="../css/profile.css">
  <link rel="stylesheet" href="../css/reward.css">
</head>
<body>

<!-- 1. AUDIO ENGINE (Crucial for Logic) -->
<audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="coinSound" src="/audio/2019-preview1.mp3"></audio>
<audio id="skipSound" src="https://static.wixstatic.com/mp3/ce3e5b_3b5b34d4083847e2b123b6fd9a8551fd.mp3"></audio>
<audio id="sfx-buy" src="/audio/2019-preview1.mp3"></audio>
<audio id="sfx-deny" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

<!-- 2. HIDDEN INPUTS (Crucial for Logic) -->
<input type="file" id="profileUploadInput" accept="image/*" class="hidden" onchange="handleProfileUpload(this)">
<input type="file" id="evidenceInput" accept="image/*,video/*" class="hidden" onchange="handleEvidenceUpload(this)">
<input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden" onchange="handleAdminUpload(this)">

<!-- 3. CELEBRATION OVERLAY -->
<div id="celebrationOverlay" style="position:fixed;inset:0;pointer-events:none;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;">
    <div class="glass-card" style="border: 2px solid var(--neon-green); text-align:center;">
        <div style="font-size:1.8rem;font-weight:900;color:var(--neon-green);text-shadow:0 0 20px var(--neon-green);">TASK<br>SUBMITTED</div>
    </div>
</div>

<!-- 4. ICONS (Used by logic) -->
<svg style="display:none;">
    <symbol id="icon-coin" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.69 1.64 1.83 1.64 1.22 0 1.6-.64 1.6-1.26 0-.81-.42-1.22-2.34-1.67-2.37-.59-3.54-1.7-3.54-3.41 0-1.68 1.29-2.94 3.28-3.29V4h2.66v1.93c1.61.27 2.87 1.28 3.01 3.05h-1.95c-.14-.99-.68-1.55-1.7-1.55-1.04 0-1.55.56-1.55 1.15 0 .75.46 1.2 2.37 1.65 2.51.6 3.58 1.74 3.58 3.52 0 1.82-1.46 3.09-3.28 3.34z"/></symbol>
    <symbol id="icon-star" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></symbol>
    <symbol id="icon-send" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></symbol>
    <symbol id="icon-timer" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></symbol>
    <symbol id="icon-gift" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-2 .89-2 2v4c0 1.11.89 2 2 2h1v6c0 1.11.89 2 2 2h10c1.11 0 2-.89 2-2v-6h1c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/></symbol>
    <symbol id="icon-sparkles" viewBox="0 0 24 24"><path d="M9.5 1L8 4.5L4.5 6L8 7.5L9.5 11L11 7.5L14.5 6L11 4.5L9.5 1zm0 0"/><path d="M19 8.5L17.5 11L15 12.5L17.5 14L19 16.5L20.5 14L23 12.5L20.5 11L19 8.5zm0 0"/><path d="M16.5 18L15.5 20L13.5 21L15.5 22L16.5 24L17.5 22L19.5 21L17.5 20L16.5 18zm0 0"/></symbol>
</svg>

<div class="hud-container">
    
    <!-- LEFT PILLAR: IDENTITY (30%) -->
    <aside class="pillar-identity">
        
        <!-- TOP: CROWN (Avatar + Kneel) -->
        <div class="crown-zone">
            <!-- Avatar Logic -->
            <div class="avatar-frame" onclick="document.getElementById('profileUploadInput').click()">
                <img id="profilePic" src="" class="pc-avatar-img">
            </div>
            
            <!-- Kneel Logic -->
            <div id="btn" class="kneel-btn-bar" 
                 onmousedown="handleHoldStart(event)" 
                 onmouseup="handleHoldEnd(event)" 
                 onmouseleave="handleHoldEnd(event)" 
                 ontouchstart="handleHoldStart(event)" 
                 ontouchend="handleHoldEnd(event)">
                <span id="fill" class="bar-fill"></span>
                <span id="txt-main" class="bar-text">KNEEL</span>
            </div>
            
            <div id="subName" class="identity-name">SLAVE</div>
        </div>

        <!-- MIDDLE: WATERMARK (Rank) -->
        <div id="subHierarchy" class="rank-watermark">LOADING...</div>

        <!-- BOTTOM: LEDGER (Stats) -->
        <div class="ledger-zone">
            <div class="stat-block">
                <span class="stat-lbl">MERIT</span>
                <span id="points" class="stat-val">0</span>
            </div>
            <div class="stat-thread"></div>
            <div class="stat-block">
                <span class="stat-lbl">CAPITAL</span>
                <span id="coins" class="stat-val">0</span>
            </div>
        </div>

        <!-- CORNER: NAV -->
        <nav class="nav-corner">
            <div class="nav-link active" onclick="switchTab('serve')">CONSOLE</div>
            <div class="nav-link" onclick="switchTab('news')">GALLERY</div>
            <div class="nav-link" onclick="switchTab('vault')">VAULT</div>
            <div class="nav-link" onclick="switchTab('buy')">STORE</div>
            <div class="nav-link" onclick="switchTab('protocol')">PROTOCOL</div>
        </nav>

        <!-- Hidden toggles for logic completeness -->
        <div class="hidden" onclick="toggleStats()">STATS</div> 
    </aside>

    <!-- RIGHT STAGE: OPERATION (70%) -->
    <main class="operation-stage">
        
        <!-- VIEW 1: HOME (SERVE) -->
        <div id="viewServingTop" class="view-wrapper">
            
            <!-- A. DIRECTIVE RIBBON (Task Logic) -->
            <div id="taskCard" class="directive-ribbon">
                <div id="activeBadge" class="hidden"></div> <!-- Prevents JS error -->
                
                <!-- Timer -->
                <div id="timerDisplay" class="ribbon-timer">00:00:00</div>
                
                <!-- Text -->
                <div id="taskContent" class="ribbon-center">
                    <span class="ribbon-title">CURRENT DIRECTIVE</span>
                    <h2 id="readyText" class="ribbon-text">AWAITING ORDERS</h2>
                </div>

                <!-- Action -->
                <div id="mainButtonsArea">
                    <button id="newTaskBtn" onclick="getRandomTask()" class="ribbon-action">[ REQUEST TASK ]</button>
                </div>

                <!-- Cooldown (Hidden Logic) -->
                <div id="cooldownSection" class="hidden" style="display: flex; gap: 10px;">
                    <button onclick="document.getElementById('evidenceInput').click()" class="ribbon-action">[ UPLOAD ]</button>
                    <button id="btnSkip" onclick="cancelPendingTask()" class="ribbon-action" style="border-color: #444; color: #666;">SKIP</button>
                </div>
            </div>

            <!-- B. CONNECTION VOID (Chat Logic) -->
            <div id="chatCard" class="connection-void">
                <div id="chatBadge" class="hidden"></div>
                
                <!-- Gallery Rail (Visual Header) -->
                <div class="media-rail-header">
                    <div style="font-family:'Inter'; font-size:0.7rem; color:var(--gold); letter-spacing:2px;">RECENT UPLOADS</div>
                    <div class="rail-thumb"></div>
                    <div class="rail-thumb"></div>
                    <div class="rail-thumb"></div>
                </div>

                <!-- Chat Body -->
                <div id="chatBody" style="flex: 1; display:flex; flex-direction:column; overflow:hidden;">
                    
                    <!-- Overlays inside Chat (Logic requires this nesting) -->
                    <div id="kneelRewardOverlay" class="hidden" style="position: absolute; inset: 0; background: rgba(0,0,0,0.92); z-index: 100; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <h2 style="color:var(--gold);">DEVOTION RECOGNIZED</h2>
                            <div style="display:flex; gap:10px; margin-top:20px;">
                                <button onclick="claimKneelReward('coins')" class="si-btn">COINS</button>
                                <button onclick="claimKneelReward('points')" class="si-btn">POINTS</button>
                            </div>
                        </div>
                    </div>

                    <div id="chatMediaOverlay" class="hidden" style="position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; display: flex; align-items: center; justify-content: center;">
                        <div id="mediaOverlayClose" onclick="closeChatPreview()" style="position:absolute; top:20px; right:20px; color:white; font-size:2rem; cursor:pointer;">X</div>
                        <div id="chatMediaOverlayContent"></div>
                    </div>

                    <div id="tributeHuntOverlay" class="hidden" style="position: absolute; inset: 0; background: #000; z-index: 150; padding: 20px;">
                        <button onclick="toggleTributeHunt()" style="color:white; float:right;">CLOSE</button>
                        <div id="huntStoreGrid" class="store-grid"></div>
                        <!-- Inputs for tribute logic -->
                        <textarea id="huntNote" class="hidden"></textarea>
                        <div id="huntProgress" class="hidden"></div>
                    </div>

                    <!-- Messages -->
                    <div id="chatContent" class="chat-stream"></div>
                </div>

                <!-- Input Line -->
                <div class="input-line-container">
                    <input type="text" id="chatMsgInput" class="void-input" placeholder="Speak..." onkeypress="handleChatKey(event)">
                    <button class="void-send" onclick="sendChatMessage()">‚Üí</button>
                    <!-- Tribute Button (Small icon) -->
                    <button id="tributeHuntBtn" onclick="toggleTributeHunt()" style="background:transparent; border:none; color:var(--gold); margin-right:10px;">üéÅ</button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: STORE (Mapped ID) -->
        <div id="viewBuy" class="view-wrapper hidden">
            <div class="directive-ribbon"><div class="ribbon-text" style="color:var(--gold);">ACQUIRE CAPITAL</div></div>
            <div class="store-grid">
                <div class="store-item"><div style="font-size:2rem; color:var(--gold);">1K</div><button class="si-btn" onclick="buyRealCoins(1000)">‚Ç¨10.00</button></div>
                <div class="store-item"><div style="font-size:2rem; color:var(--gold);">5.5K</div><button class="si-btn" onclick="buyRealCoins(5500)">‚Ç¨50.00</button></div>
                <div class="store-item"><div style="font-size:2rem; color:var(--gold);">12K</div><button class="si-btn" onclick="buyRealCoins(12000)">‚Ç¨100.00</button></div>
                <div class="store-item"><div style="font-size:2rem; color:var(--gold);">30K</div><button class="si-btn" onclick="buyRealCoins(30000)">‚Ç¨250.00</button></div>
                <div class="store-item"><div style="font-size:2rem; color:var(--gold);">70K</div><button class="si-btn" onclick="buyRealCoins(70000)">‚Ç¨500.00</button></div>
                <div class="store-item"><div style="font-size:2rem; color:var(--gold);">150K</div><button class="si-btn" onclick="buyRealCoins(150000)">‚Ç¨1000.00</button></div>
            </div>
        </div>

        <!-- VIEW 3: GALLERY -->
        <div id="viewNews" class="view-wrapper hidden">
            <div class="directive-ribbon"><div class="ribbon-text" style="color:var(--gold);">THE QUEEN'S IMAGE</div></div>
            <div id="newsGrid" class="gallery-grid"></div>
        </div>

        <!-- VIEW 4: VAULT -->
        <div id="viewVault" class="view-wrapper hidden">
            <div class="directive-ribbon"><div class="ribbon-text" style="color:var(--gold);">UNLOCKED ASSETS</div></div>
            <div id="vaultGrid" class="gallery-grid"></div>
        </div>

        <!-- VIEW 5: PROTOCOL -->
        <div id="viewProtocol" class="view-wrapper hidden">
            <div class="directive-ribbon"><div class="ribbon-text" style="color:var(--gold);">LAW</div></div>
            <div class="protocol-container">
                <div class="protocol-item">
                    <div class="protocol-header">OBEDIENCE</div>
                    <p>Your worth is determined solely by your submission.</p>
                </div>
            </div>
        </div>

        <!-- HIDDEN LOGIC PLACEHOLDERS -->
        <div id="viewRewards" class="hidden"></div>
        <div id="viewHierarchy" class="hidden"></div>
        <div id="viewSession" class="hidden"></div>
        <div id="pendingSection" class="hidden"></div>
        <div id="historySection" class="hidden"></div>

    </main>
</div>

<!-- SCRIPT: The Brain (Restored Logic) -->
<script>
    document.querySelectorAll("[data-include]").forEach(async el => {
        const file = el.getAttribute("data-include");
        try { const html = await fetch(file).then(r => r.text()); el.innerHTML = html; } catch (err) {}
    });

    window.switchTab = function(viewId) {
        document.querySelectorAll('.nav-link').forEach(item => {
            if(item.getAttribute('onclick').includes(viewId)) item.classList.add('active');
            else item.classList.remove('active');
        });

        const views = ['viewServingTop', 'viewProtocol', 'viewNews', 'viewVault', 'viewBuy'];
        views.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });

        let targetId = viewId;
        if(viewId === 'serve') targetId = 'viewServingTop';
        if(viewId === 'news') targetId = 'viewNews';
        if(viewId === 'buy') targetId = 'viewBuy';
        if(viewId === 'vault') targetId = 'viewVault';
        if(viewId === 'protocol') targetId = 'viewProtocol';

        const target = document.getElementById(targetId);
        if(target) target.classList.remove('hidden');

        if(typeof window.showView === 'function') {
            window.showView(targetId);
        }
    }
</script>

</body>
</html>
