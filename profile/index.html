<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
    <title>Command Console</title>

    <script type="module" src="../js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@200;300;400;600&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap"
        rel="stylesheet" />

    <!-- DESKTOP STYLES -->
    <link rel="stylesheet" href="../css/chat.css">
    <link rel="stylesheet" href="../css/profile.css">
    <link rel="stylesheet" href="../css/reward.css">

    <style>
        /* =========================================
       1. CORE LAYOUT & SCROLLING (CLEANED)
       ========================================= */
        #MOBILE_APP {
            display: none;
        }

        /* --- CRITICAL APP SHELL LOCK (GLOBAL) --- */
        /* This applies to BOTH Desktop and Mobile to stop the "Wix Scroll" */
        html,
        body {

            width: 100% !important;
            height: 100% !important;
            overflow: hidden !important;
            /* Kills outer scrollbar */
            background-color: transparent !important;
            margin: 0 !important;
            padding: 0 !important;
            top: 0 !important;
            left: 0 !important;
            overscroll-behavior: none !important;
            /* Kills iOS bounce */
            touch-action: none;
            /* Kills pinch-zoom on mobile */
        }

        .mobile-only-trigger {
            display: none !important;
        }

        /* --- MOBILE SPECIFIC STYLES --- */
        @media screen and (max-width: 768px) {

            #MOBILE_APP {
                display: block !important;
                width: 100vw;
                height: 100dvh;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 999999;
                background-color: transparent !important;
                color: white;
                font-family: 'Cinzel', serif;
                overflow: hidden;
            }

            #DESKTOP_APP {
                display: none !important;
            }

            /* NOTE: I removed the duplicate 'html, body' block here. 
           The global one at the top handles it perfectly. */

            /* The ONLY thing allowed to scroll is the View Container */
            /* The ONLY thing allowed to scroll is the View Container */
            /* The ONLY thing allowed to scroll is the View Container */
            #viewMobileHome {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                /* CHANGED FROM 100vw TO 100% */
                height: 100dvh;

                overflow-y: auto !important;
                overflow-x: hidden !important;

                /* SCROLL PHYSICS */
                -webkit-overflow-scrolling: touch !important;
                touch-action: pan-y !important;
                overscroll-behavior: none !important;

                /* GPU */
                will-change: scroll-position;
                transform: translateZ(0);

                display: block;
                padding: 0;
                z-index: 1;
                background: transparent !important;
            }

            /* HIDE ALL SCROLLBARS */
            #viewMobileHome::-webkit-scrollbar,
            #mobHomeScroll::-webkit-scrollbar,
            #mobGlobalScroll::-webkit-scrollbar,
            #mobRecordScroll::-webkit-scrollbar,
            .mob-horiz-scroll::-webkit-scrollbar,
            .qm-scroll-content::-webkit-scrollbar {
                display: none !important;
                width: 0 !important;
                height: 0 !important;
                background: transparent !important;
            }

            /* =========================================
           2. HALO DASHBOARD
           ========================================= */
            .mobile-only-trigger {
                display: block !important;
            }

            .halo-section {
                position: relative;
                z-index: 2;
                margin-top: 60px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .halo-ring {
                width: 280px;
                height: 280px;
                border-radius: 50%;
                border: 2px solid #c5a059;
                box-shadow: 0 0 30px rgba(197, 160, 89, 0.4), inset 0 0 20px rgba(197, 160, 89, 0.2);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;

                /* --- ADD THIS FOR THE BLUR --- */
                background: rgba(0, 0, 0, 0.3);
                /* Slight dark tint so text pops */
                backdrop-filter: blur(10px);
                /* The Blur Effect */
                -webkit-backdrop-filter: blur(10px);
                /* Required for iPhone */
            }

            .halo-name {
                font-family: 'Cinzel', serif;
                font-size: 2.2rem;
                color: #fff;
                text-transform: uppercase;
                letter-spacing: 2px;
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
                line-height: 1;
                margin-bottom: 5px;
                text-align: center;
            }

            .halo-rank {
                font-family: 'Orbitron', sans-serif;
                font-size: 0.7rem;
                color: #c5a059;
                letter-spacing: 4px;
                text-transform: uppercase;
            }

            /* STATS CARD */
            .halo-stats-card {
                position: relative;
                z-index: 3;
                margin-top: -40px;
                width: 90%;
                background: rgba(10, 10, 10, 0.85);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 10px;
                display: flex;
                align-items: center;
                justify-content: space-around;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(15px);
                margin-bottom: 20px;
            }

            .h-stat {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .h-val {
                font-family: 'Orbitron', serif;
                font-size: 1.5rem;
                color: #fff;
                line-height: 1;
            }

            .h-lbl {
                font-family: 'Orbitron', sans-serif;
                font-size: 0.5rem;
                color: #888;
                letter-spacing: 2px;
                margin-top: 4px;
            }

            .h-divider {
                width: 1px;
                height: 30px;
                background: rgba(255, 255, 255, 0.15);
            }

            .halo-stack {
                position: relative;
                z-index: 3;
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
                padding: 0 20px;
            }

            /* =========================================
           3. STATS DRAWER (RESTORED)
           ========================================= */
            .mob-hud-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                padding: 20px;
                box-sizing: border-box;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 10;
            }

            .hud-circle {
                width: 45px;
                height: 45px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                cursor: pointer;
                position: relative;
            }

            .hud-circle img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 50%;
            }

            .mob-stats-toggle-btn {
                width: 100%;
                background: transparent;
                border: 1px solid rgba(136, 136, 136, 0.3);
                color: #888;
                opacity: 0.7;
                font-family: 'Cinzel', serif;
                font-weight: 700;
                font-size: 0.75rem;
                padding: 8px 0;
                cursor: pointer;
                letter-spacing: 2px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                border-radius: 4px;
                transition: 0.3s;
            }

            .mob-stats-toggle-btn:active {
                opacity: 1;
                border-color: #fff;
                color: #fff;
            }

            .mob-internal-drawer {
                width: 100%;
                max-height: 0;
                opacity: 0;
                overflow: hidden;
                transition: all 0.4s ease;
                transition: all 0.4s ease;
                background: transparent;
                border-top: 1px solid transparent;
                box-sizing: border-box;
            }

            /* SAFETY: PREVENT LONG TEXT EXPANDING DRAWER */
            #drawer_CurrentRank,
            #drawer_NextRank {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
                display: block;
            }

            #drawer_ProgressContainer {
                max-width: 100%;
                overflow: hidden;
                box-sizing: border-box;
            }

            .mob-internal-drawer.open {
                max-height: 1200px;
                opacity: 1;
                margin-top: 15px;
                padding: 20px 10px;
                border: 1px solid #333;
                background: rgba(0, 0, 0, 0.9);
                border-radius: 8px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            }

            .drawer-row {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .drawer-row:last-child {
                border-bottom: none;
            }

            .d-lbl {
                font-size: 0.7rem;
                color: #888;
                font-family: 'Cinzel';
                letter-spacing: 1px;
            }

            .d-val {
                font-size: 0.8rem;
                color: #c5a059;
                font-family: 'Orbitron';
            }

            /* =========================================
           4. KNEEL BAR & BUTTONS (RESTORED)
           ========================================= */
            .mob-section-wrapper {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 5px;
            }

            .mob-kneel-bar {
                width: 100%;
                height: 50px;
                background: #080808;
                border: 1px solid #c5a059;
                border-radius: 4px;
                position: relative;
                overflow: hidden;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 0 10px rgba(197, 160, 89, 0.1);
                transition: 0.2s;
            }

            .mob-kneel-bar:active {
                border-color: #fff;
                transform: scale(0.98);
            }

            .mob-bar-fill,
            .mob-kneel-fill {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 0%;
                height: 100%;
                background: linear-gradient(90deg, #8b0000, #000000);
                z-index: 1;
                transition: width 0.1s linear;
            }

            .mob-bar-content {
                z-index: 2;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .kneel-icon-sm {
                color: #c5a059;
                font-size: 1.2rem;
            }

            .kneel-text {
                font-family: 'Cinzel', serif;
                letter-spacing: 3px;
                color: #ccc;
            }

            .mob-action-btn {
                width: 100%;
                padding: 15px;
                background: transparent;
                margin-top: 15px;
                border: 1px solid #c5a059;
                color: #c5a059;
                font-family: 'Cinzel', serif;
                font-weight: 700;
                font-size: 0.9rem;
                letter-spacing: 2px;
                cursor: pointer;
            }

            /* FIX MOBILE CHAT SCROLL GLITCH */
            #mob_chatBox {
                /* 1. TRAP THE SCROLL (Stop it from moving the dashboard) */
                overscroll-behavior: contain !important;

                /* 2. FORCE GPU (Smoothness) */
                will-change: scroll-position;
                transform: translateZ(0);

                /* 3. STRICT VERTICAL ONLY */
                touch-action: pan-y !important;

                /* 4. ENSURE WIDTH SAFETY */
                width: 100% !important;
                max-width: 100% !important;
                overflow-x: hidden !important;
            }

            /* Ensure the wrapper doesn't cause issues either */
            #inlineChatPanel {
                width: 100% !important;
                max-width: 100% !important;
                overflow: hidden !important;
                /* No scrolling on the wrapper, only the box */
            }

            /* FIX MODAL SCROLL GLITCH */
            #glassModal {
                /* Prevent scroll from passing through to the dashboard */
                overscroll-behavior: contain !important;

                /* Force GPU to prevent rendering glitches */
                will-change: transform;
                transform: translateZ(0);
            }

            /* If the text box inside needs scrolling, let it scroll smoothly */
            .theater-text-box,
            .modal-verdict-box {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }

            /* --- JAIL LOGIC --- */
            /* Forces the overlay to stick inside the trophy box */
            #trophySectionJail #rewardCardOverlay {
                position: absolute !important;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 50;
                background: rgba(0, 0, 0, 0.98) !important;
                padding-top: 20px !important;
                align-items: flex-start !important;
            }

            /* Adjust card size to fit the jail */
            #trophySectionJail .mob-reward-card {
                width: 95% !important;
                max-height: 95% !important;
                margin: 0 auto !important;
                border: 1px solid #c5a059;
            }

            /* --- GALLERY STICKER (Reward Badge) --- */
            .gallery-sticker-badge {
                position: absolute;
                bottom: 5px;
                right: 5px;
                width: 35px;
                /* Adjust size as needed */
                height: 35px;
                z-index: 5;
                object-fit: contain;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8));
                transform: rotate(-10deg);
                /* Slight tilt for realism */
                pointer-events: none;
                /* Let clicks pass through to the card */
            }

            /* Make it slightly smaller on mobile lists if needed */
            .mob-scroll-item .gallery-sticker-badge {
                width: 25px;
                height: 25px;
                bottom: 2px;
                right: 2px;
            }



            /* FIX QUEEN'S WALL ON MOBILE */
            #mobNewsGrid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                /* 2 Columns */
                gap: 10px !important;
                width: 100% !important;
                padding-bottom: 50px;
            }

            /* Force the items to fit the mobile grid */
            #mobNewsGrid .sg-item {
                width: 100% !important;
                height: auto !important;
                min-height: 150px !important;
                position: relative !important;
                /* Reset any desktop absolute positioning */
                display: flex !important;
                flex-direction: column !important;
                background: #000;
                border: 1px solid #333;
            }

            /* Make images fill the box */
            #mobNewsGrid .sg-img {
                width: 100% !important;
                height: 120px !important;
                object-fit: cover !important;
            }

            /* Make text visible */
            #mobNewsGrid .news-txt {
                display: block !important;
                padding: 5px;
                font-size: 0.7rem;
                color: #ccc;
            }

            /* =========================================
           5. LUXURY CARDS (RESTORED)
           ========================================= */
            .luxury-wrap {
                padding: 0 20px;
                display: flex;
                flex-direction: column;
                gap: 20px;
                width: 100%;
            }

            .luxury-card {
                background: linear-gradient(180deg, rgba(30, 30, 30, 0.6) 0%, rgba(10, 10, 10, 0.9) 100%);
                border: 1px solid rgba(197, 160, 89, 0.2);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                border-radius: 2px;
                padding: 20px 15px;
                position: relative;
                overflow: hidden;
                width: 90%;
                margin: 10px auto;
            }

            .luxury-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 1px;
                background: linear-gradient(90deg, transparent 0%, #c5a059 50%, transparent 100%);
                opacity: 0.7;
            }

            .duty-label {
                font-family: 'Cinzel', serif;
                font-weight: 700;
                font-size: 0.7rem;
                color: #888;
                letter-spacing: 4px;
                text-transform: uppercase;
                text-align: center;
                margin-bottom: 20px;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                margin-top: 30px;
            }

            .duty-label::before,
            .duty-label::after {
                content: '';
                height: 1px;
                width: 30px;
                background: #333;
            }

            /* Timers & Task Text */
            .card-timer-row {
                display: flex !important;
                flex-direction: row !important;
                align-items: center;
                justify-content: center;
                gap: 5px;
                margin: 15px 0;
                width: 100%;
            }

            .card-t-box {
                background: #000;
                border: 1px solid #333;
                color: #c5a059;
                font-family: 'Rajdhani', sans-serif;
                font-size: 1.5rem;
                padding: 5px 10px;
                border-radius: 4px;
                min-width: 40px;
                text-align: center;
                line-height: 1;
            }

            #mobTaskText {
                font-family: 'Cinzel', serif;
                font-size: 0.85rem;
                color: #e0e0e0;
                text-align: center;
                line-height: 1.4;
                margin: 5px 0 15px 0;
                padding: 8px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: rgba(0, 0, 0, 0.3);
                min-height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
            }

            .text-pulse {
                animation: pulseText 1.5s infinite;
                color: #c5a059 !important;
                font-family: 'Orbitron' !important;
            }

            @keyframes pulseText {
                0% {
                    opacity: 0.5;
                }

                50% {
                    opacity: 1;
                }

                100% {
                    opacity: 0.5;
                }
            }

            /* Status Texts */
            .txt-status-red {
                color: #ff003c;
                font-family: 'Orbitron';
                font-size: 0.8rem;
                letter-spacing: 1px;
                text-shadow: 0 0 5px rgba(255, 0, 60, 0.4);
            }

            .txt-status-green {
                color: #00ff00;
                font-family: 'Orbitron';
                font-size: 0.8rem;
                letter-spacing: 1px;
                text-shadow: 0 0 5px rgba(0, 255, 0, 0.4);
            }

            .txt-status-gold {
                color: #c5a059;
                font-family: 'Orbitron';
                font-size: 0.8rem;
                letter-spacing: 1px;
            }

            .btn-upload-sm {
                background: transparent;
                border: 1px solid #c5a059;
                color: #c5a059;
                font-family: 'Cinzel';
                font-size: 0.65rem;
                padding: 6px 12px;
                cursor: pointer;
                align-self: flex-start;
            }

            .btn-skip-sm {
                background: transparent;
                border: 1px solid #444;
                color: #666;
                font-family: 'Cinzel';
                font-size: 0.65rem;
                padding: 6px 12px;
                cursor: pointer;
            }

            /* =========================================
           6. RECORD / GALLERY / STREAKS (RESTORED THE SQUARES)
           ========================================= */
            .mob-grid-label-center {
                font-size: 0.5rem;
                color: #444;
                letter-spacing: 3px;
                margin-bottom: 5px;
                text-align: center;
                width: 100%;
            }

            .mob-streak-strip {
                display: grid;
                grid-template-columns: repeat(12, 1fr);
                gap: 3px;
                width: 70%;
                margin-bottom: 10px;
            }

            .streak-sq {
                height: 6px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 1px;
            }

            .streak-sq.active {
                background: rgba(197, 160, 89, 0.6);
                border-color: #c5a059;
                box-shadow: 0 0 8px rgba(197, 160, 89, 0.2);
            }

            .mob-horiz-scroll {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                gap: 10px;
                width: 100%;
                padding-right: 20px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding-left: 10px;
            }

            .mob-horiz-scroll::-webkit-scrollbar {
                display: none;
            }

            .mob-pyramid-stage {
                position: relative;
                width: 100%;
                height: 260px;
                margin-top: 15px;
                perspective: 1000px;
            }

            .mob-idol {
                position: absolute;
                background: #000;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .mob-idol img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

            .mob-idol.center {
                width: 160px;
                height: 230px;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                z-index: 20;
                border: 2px solid #c5a059;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9), 0 0 20px rgba(197, 160, 89, 0.2);
            }

            .mob-idol.side {
                width: 130px;
                height: 190px;
                top: 50px;
                left: 10%;
                z-index: 5;
                border: 1px solid #444;
                filter: brightness(0.5) grayscale(50%);
                transform: rotate(-6deg);
            }

            .mob-idol.side.right {
                left: auto;
                right: 10%;
                transform: rotate(6deg);
            }

            .mob-rank-badge {
                position: absolute;
                bottom: -10px;
                left: 50%;
                transform: translateX(-50%);
                background: #000;
                border: 1px solid #333;
                color: #888;
                font-family: 'Cinzel', serif;
                font-size: 0.6rem;
                padding: 2px 6px;
                z-index: 30;
            }

            .mob-rank-badge.main {
                border-color: #c5a059;
                color: #c5a059;
                bottom: 10px;
                background: rgba(0, 0, 0, 0.8);
            }

            .mob-scroll-item {
                flex: 0 0 120px;
                height: 160px;
                position: relative;
                border: 1px solid #333;
                background: #111;
                border-radius: 4px;
                overflow: hidden;
                margin-right: 10px;
            }

            .mob-horiz-scroll.small .mob-scroll-item {
                flex: 0 0 80px;
                height: 80px;
                opacity: 0.6;
            }

            .mob-scroll-img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

            /* =========================================
           7. HUD & LOBBY (RESTORED TOP CIRCLES)
           ========================================= */
            .mob-hud-row {
                position: absolute;
                top: 15px;
                left: 0;
                width: 100%;
                display: flex;
                justify-content: space-between;
                padding: 0 20px;
                z-index: 10;
            }

            .hud-circle {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                border: 1px solid rgba(255, 255, 255, 0.2);
                background: #000;
                position: relative;
                overflow: visible;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            }

            .hud-circle img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 50%;
                opacity: 0.8;
            }

            .hud-gear {
                position: absolute;
                bottom: -5px;
                right: -5px;
                font-size: 0.8rem;
                color: #fff;
                text-shadow: 0 0 5px #000;
            }

            .hud-status-dot {
                position: absolute;
                bottom: 0;
                right: 0;
                width: 10px;
                height: 10px;
                border-radius: 50%;
                border: 2px solid #000;
            }

            .hud-status-dot.online {
                background: #00ff00;
                box-shadow: 0 0 10px #00ff00;
            }

            .hud-status-dot.offline {
                background: #c5a059;
                box-shadow: 0 0 5px #c5a059;
                opacity: 0.5;
            }

            /* LOBBY / SETTINGS */
            .lobby-card {
                max-height: 75vh !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .lobby-card::-webkit-scrollbar {
                display: none;
            }

            .lobby-header {
                margin-bottom: 25px;
                text-align: center;
            }

            .lobby-title {
                font-family: 'Cinzel', serif;
                font-size: 1.4rem;
                color: #c5a059;
                letter-spacing: 4px;
                border-bottom: 1px solid #333;
                padding-bottom: 10px;
                display: inline-block;
            }

            .lobby-subtitle {
                font-family: 'Cinzel', serif;
                font-size: 0.6rem;
                color: #666;
                margin-top: 5px;
                letter-spacing: 2px;
            }

            .lobby-content {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }

            .lobby-btn {
                background: transparent;
                border: 1px solid #333;
                color: #ccc;
                font-family: 'Cinzel', serif;
                font-size: 0.8rem;
                padding: 12px;
                width: 100%;
                cursor: pointer;
                transition: 0.3s;
                letter-spacing: 2px;
            }

            .lobby-btn:active {
                background: rgba(255, 255, 255, 0.05);
                border-color: #666;
            }

            .lobby-btn.gold {
                border-color: #c5a059;
                color: #c5a059;
                font-weight: 700;
            }

            .lobby-btn.close {
                border: none;
                color: #555;
                font-size: 0.7rem;
                margin-top: 5px;
            }

            .lobby-prompt {
                font-family: 'Cinzel', serif;
                color: white;
                font-size: 1rem;
                text-align: center;
                margin-bottom: 15px;
                line-height: 1.4;
            }

            .lobby-input {
                background: #111;
                border: 1px solid #444;
                color: #c5a059;
                font-family: 'Cinzel', serif;
                font-size: 1rem;
                padding: 10px;
                width: 100%;
                text-align: center;
                outline: none;
            }

            .lobby-cost-area {
                margin-top: 10px;
                margin-bottom: 5px;
                font-size: 0.7rem;
                color: #666;
                font-family: 'Orbitron';
                letter-spacing: 1px;
            }

            .cost-val {
                color: #c5a059;
                font-weight: bold;
                margin-left: 5px;
            }

            .routine-grid {
                display: flex;
                flex-direction: column;
                gap: 10px;
                width: 100%;
                margin-bottom: 15px;
            }

            .routine-tile {
                width: 100%;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid #333;
                padding: 15px;
                text-align: center;
                font-family: 'Cinzel', serif;
                font-size: 0.8rem;
                color: #888;
                cursor: pointer;
                transition: 0.2s;
                border-radius: 2px;
                letter-spacing: 2px;
            }

            .routine-tile.selected {
                background: rgba(197, 160, 89, 0.1);
                border-color: #c5a059;
                color: #c5a059;
                font-weight: 700;
            }

            .routine-tile.special {
                border-style: dashed;
                color: #ccc;
            }

            /* =========================================
           8. GLOBAL / COINS / OVERLAYS (RESTORED)
           ========================================= */
            .wallet-btn {
                width: 100%;
                padding: 15px;
                background: transparent;
                border: 1px solid #c5a059;
                color: #c5a059;
                font-family: 'Cinzel', serif;
                font-weight: 700;
                font-size: 0.9rem;
                letter-spacing: 2px;
                cursor: pointer;
                box-shadow: 0 0 15px rgba(197, 160, 89, 0.2);
            }

            .coin-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                width: 100%;
                margin-top: 15px;
            }

            .coin-tile {
                background: rgba(20, 20, 20, 0.9);
                border: 1px solid #333;
                border-radius: 4px;
                padding: 15px 5px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 5px;
                cursor: pointer;
            }

            .coin-amount {
                font-family: 'Rajdhani', sans-serif;
                font-size: 1.4rem;
                color: #c5a059;
                font-weight: 700;
                line-height: 1;
            }

            .coin-price {
                font-family: 'Cinzel', serif;
                font-size: 0.7rem;
                color: #888;
            }

            .hidden {
                display: none !important;
            }

            /* 1. OVERLAY: ALIGN TO TOP (Instead of Center) */
            .mob-reward-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 2147483647;
                /* Highest Level */

                /* THE ALIGNMENT FIX */
                display: flex;
                justify-content: center;
                align-items: flex-start !important;
                /* Pushes content to the top */
                padding-top: 80px !important;
                /* Adds space so it doesn't hit the very top edge */

                backdrop-filter: blur(8px);
                animation: fadeIn 0.3s ease;
            }

            /* 2. THE CARD: ENABLE SCROLLING (The Right Circle Fix) */
            /* Applies to both Lobby and Queen Menu */
            .mob-reward-card,
            .queen-card-layout,
            .lobby-card {
                background: #111;
                border: 1px solid #c5a059;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                width: 90%;
                box-shadow: 0 0 30px rgba(197, 160, 89, 0.2);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;

                /* THE SCROLL FIX */
                max-height: 80vh !important;
                /* Limits height to 80% of screen */
                overflow-y: auto !important;
                /* Enables vertical scrolling */
                -webkit-overflow-scrolling: touch !important;
                /* Smooth scroll on iPhone */

                /* PREVENTS CLIPPING */
                margin-bottom: 50px;
            }

            /* REWARDS TROPHY CASE STYLES */
            .reward-shelf {
                display: flex;
                gap: 15px;
                padding: 10px 15px;
                width: 100%;
                overflow-x: auto;
                scrollbar-width: none;
                align-items: center;
            }

            .reward-badge {
                flex: 0 0 70px;
                height: 70px;
                background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
                border: 1px solid #333;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                position: relative;
                transition: all 0.3s;
            }

            .reward-badge.shape-hex {
                clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
                width: 70px;
                height: 80px;
                border: none;
                background: #111;
            }

            .reward-badge.shape-hex::before {
                content: '';
                position: absolute;
                inset: 1px;
                background: #1a1a1a;
                clip-path: inherit;
                z-index: -1;
            }

            .reward-badge.shape-chip {
                clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
            }

            .reward-badge.shape-circle {
                border-radius: 50%;
            }

            .reward-badge.shape-diamond {
                transform: rotate(45deg);
                width: 55px;
                height: 55px;
                margin: 10px;
            }

            .reward-badge.shape-diamond .rb-inner {
                transform: rotate(-45deg);
            }

            .rb-icon {
                width: 24px;
                height: 24px;
                fill: #444;
                margin-bottom: 5px;
            }

            .rb-label {
                font-family: 'Orbitron';
                font-size: 0.45rem;
                color: #444;
                text-transform: uppercase;
            }

            .reward-badge.unlocked .rb-icon {
                fill: #c5a059;
                filter: drop-shadow(0 0 5px rgba(197, 160, 89, 0.5));
            }

            .reward-badge.unlocked .rb-label {
                color: #ccc;
            }

            .reward-badge.unlocked.shape-hex {
                background: #c5a059;
            }

            .reward-badge.unlocked.shape-hex::before {
                background: #111;
            }

            .reward-badge.unlocked.shape-circle {
                border-color: #c5a059;
            }

            .reward-badge.unlocked.shape-chip {
                border-right: 2px solid #c5a059;
            }

            .reward-badge.unlocked.shape-diamond {
                border-color: #c5a059;
            }

            /* THE WALL (NEWS GRID) */
            #mobNewsGrid {
                padding-bottom: 40px;
            }

            .news-item {
                border: 1px solid #333;
                background: #000;
                min-height: 150px;
                display: flex;
                flex-direction: column;
            }

            .news-img {
                width: 100%;
                height: 150px;
                object-fit: cover;
            }

            .news-txt {
                padding: 10px;
                color: #888;
                font-family: 'Cinzel';
                font-size: 0.7rem;
            }

            /* CHAT OVERLAY STYLE (FORCED HIDDEN) */
            #chatCard {
                display: none !important;
            }

            .mob-chat-header {
                display: flex;
                align-items: center;
                padding: 10px 15px;
                background: #111;
                border-bottom: 1px solid #333;
            }

            .queen-av-wrap {
                position: relative;
                width: 40px;
                height: 40px;
                margin-right: 10px;
            }

            .queen-av-img {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
            }

            .chat-meta-col {
                display: flex;
                flex-direction: column;
            }

            .chat-queen-name {
                color: #fff;
                font-family: 'Cinzel';
                font-size: 0.9rem;
            }

            .chat-status-text {
                color: #00ff00;
                font-family: 'Orbitron';
                font-size: 0.6rem;
                letter-spacing: 1px;
            }

            .chat-footer {
                display: flex;
                align-items: center;
                padding: 10px;
                background: #111;
                border-top: 1px solid #333;
                gap: 10px;
            }

            .chat-input-wrapper {
                flex: 1;
                position: relative;
                display: flex;
                align-items: center;
            }

            .chat-input {
                width: 100%;
                background: #000;
                border: 1px solid #333;
                color: #fff;
                padding: 10px 10px 10px 40px;
                font-family: 'Cinzel';
                outline: none;
                border-radius: 20px;
            }

            .chat-btn-plus {
                position: absolute;
                left: 5px;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                background: #222;
                border: 1px solid #444;
                color: #fff;
                cursor: pointer;
            }

            .chat-btn-send {
                background: #c5a059;
                color: #000;
                border: none;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                font-weight: bold;
                cursor: pointer;
            }
        }
    </style>
</head>

<body>

    <!-- SOUNDS & INPUTS -->
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="coinSound" src="/audio/2019-preview1.mp3"></audio>
    <audio id="skipSound" src="https://static.wixstatic.com/mp3/ce3e5b_3b5b34d4083847e2b123b6fd9a8551fd.mp3"></audio>
    <audio id="sfx-buy" src="/audio/2019-preview1.mp3"></audio>
    <audio id="sfx-deny" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

    <input type="file" id="profileUploadInput" accept="image/*" class="hidden" onchange="handleProfileUpload(this)">
    <input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden" onchange="handleAdminUpload(this)">

    <!-- CELEBRATION OVERLAY -->
    <div id="celebrationOverlay"
        style="position:fixed;inset:0;pointer-events:none;z-index:2147483647;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;">
        <div class="glass-card" style="border: 2px solid var(--neon-green); text-align:center;">
            <div
                style="font-size:1.8rem;font-weight:900;color:var(--neon-green);text-shadow:0 0 20px var(--neon-green); font-family: 'Orbitron';">
                TASK<br>SUBMITTED</div>
        </div>
    </div>
    <!-- =======================================================
     UNIVERSE A: DESKTOP APP (WRAPPED)
     ======================================================= -->
    <div id="DESKTOP_APP">
        <div class="v-sidebar">
            <div class="v-brand"
                style="font-family: 'Orbitron'; font-size: 1.2rem; font-weight: 900; color: var(--gold); letter-spacing: 4px; padding: 20px 0; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;">
                VISION UI
            </div>

            <div class="v-card" style="margin-bottom: 20px; text-align: center; padding: 15px;">
                <div id="subHierarchy" class="hierarchy-top"
                    style="transform: none; margin: 0 auto 15px; font-size: 0.7rem; border-color: var(--gold-dim); background: rgba(0,0,0,0.2);">
                    LOADING...</div>
                <div class="avatar-container" style="width: 100px; height: 115px; margin: 0 auto 10px; padding: 2px;"
                    onclick="document.getElementById('profileUploadInput').click()">
                    <img id="profilePic" src="" alt="Avatar" style="filter: none;">
                </div>
                <div id="subName" class="identity-name"
                    style="font-size: 1.1rem; letter-spacing: 3px; margin-bottom: 5px;">SLAVE</div>
                <div id="nextLevelName"
                    style="color: var(--gold); font-size: 0.65rem; font-family: 'Cinzel'; letter-spacing: 1px;">NEXT
                    RANK: -</div>
            </div>

            <div class="nav-menu">
                <button class="nav-btn active" onclick="switchTab('serve')">
                    <span style="font-size: 1.2rem; margin-right: 10px;">üè†</span> DASHBOARD
                </button>
                <button class="nav-btn" onclick="switchTab('record')">
                    <span style="font-size: 1.2rem; margin-right: 10px;">üìú</span> RECORDS
                </button>
                <button class="nav-btn" onclick="switchTab('buy')">
                    <span style="font-size: 1.2rem; margin-right: 10px;">üí∞</span> EXCHEQUER
                </button>
                <button class="nav-btn" onclick="switchTab('news')">
                    <span style="font-size: 1.2rem; margin-right: 10px;">üìñ</span> LIBRARY
                </button>
            </div>
        </div>

        <div class="v-main-content">
            <!-- 4 STAT CARDS -->
            <!-- KNEELING COUNTER (8 KNEELS REQUIRED) -->
            <div class="v-card v-stat-card v-span-1" style="flex-direction: column; align-items: stretch; gap: 10px;">
                <div class="ribbon-label" style="text-align: center;">KNEELING HOURS</div>
                <div class="prog-bg"
                    style="height: 25px; border-radius: 12px; position: relative; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); overflow: hidden;">
                    <div id="deskKneelDailyFill" class="prog-fill"
                        style="width: 0%; background: var(--gold); height: 100%; transition: width 0.5s ease;"></div>
                    <div id="deskKneelDailyText"
                        style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 0.8rem; color: white; text-shadow: 0 1px 3px black;">
                        0 / 8</div>
                </div>
            </div>

            <!-- DAILY ROUTINE (MANDATORY PROTOCOL) -->
            <div class="v-card v-stat-card v-span-1" style="flex-direction: column; align-items: stretch; gap: 5px;">
                <div class="ribbon-label" style="text-align: center;">MANDATORY PROTOCOL</div>
                <div id="deskRoutineDisplay"
                    style="font-family: 'Orbitron'; font-size: 0.75rem; color: white; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 5px;">
                    LOADING...</div>
                <div style="display: flex; justify-content: center; gap: 5px; align-items: center; margin-top: 2px;">
                    <button id="deskRoutineUploadBtn" class="v-icon-box"
                        style="width: 30px; height: 30px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; background: var(--blue-accent);"
                        onclick="document.getElementById('routineUploadInput').click()">
                        <i class="fas fa-upload"></i>
                    </button>
                    <div id="deskRoutineDoneMsg" class="hidden"
                        style="color: var(--neon-green); font-family: 'Orbitron'; font-size: 0.7rem;">‚úî DONE</div>
                    <div id="deskRoutineTimeMsg" class="hidden"
                        style="color: #666; font-family: 'Cinzel'; font-size: 0.6rem;">CLOSED</div>
                </div>
            </div>

            <!-- DAILY TASK COUNTER (LABOR COMPLETED) -->
            <div class="v-card v-stat-card v-span-1" style="justify-content: space-around;">
                <div style="text-align: center;">
                    <div class="ribbon-label" style="font-size: 0.55rem; opacity: 0.7;">STREAK</div>
                    <div id="deskStreak" style="font-family: 'Orbitron'; font-size: 1.5rem; color: white;">0</div>
                </div>
                <div style="height: 30px; width: 1px; background: rgba(255,255,255,0.1);"></div>
                <div style="text-align: center;">
                    <div class="ribbon-label" style="font-size: 0.55rem; opacity: 0.7;">TOTAL</div>
                    <div id="deskTotal" style="font-family: 'Orbitron'; font-size: 1.5rem; color: var(--gold);">0</div>
                </div>
            </div>

            <!-- TRIBUTE TOTAL (NET TRIBUTE) -->
            <div class="v-card v-stat-card v-span-1">
                <div>
                    <div class="ribbon-label">TRIBUTE TOTAL</div>
                    <div id="deskNetTribute" style="font-family: 'Orbitron'; font-size: 1.5rem; color: #f5d142;">0</div>
                </div>
                <div class="v-icon-box" style="background: linear-gradient(135deg, #f5d142, #f2a900);"><i
                        class="fas fa-coins"></i></div>
            </div>

            <!-- HERO & SATISFACTION -->
            <div class="v-card v-span-2"
                style="background: url('https://static.wixstatic.com/media/ce3e5b_13b4c9faf6c5471ca7d292968d40feee~mv2.png'); background-size: cover; background-position: center; min-height: 200px; display: flex; flex-direction: column; justify-content: center; position: relative; overflow: hidden;">
                <div
                    style="position: absolute; inset: 0; background: linear-gradient(90deg, rgba(2,5,18,0.9) 0%, rgba(2,5,18,0.4) 100%);">
                </div>
                <div style="position: relative; z-index: 1;">
                    <p
                        style="color: rgba(255,255,255,0.6); font-family: 'Cinzel'; font-size: 0.8rem; letter-spacing: 2px; margin: 0;">
                        Welcome back,</p>
                    <h2 id="heroUserName"
                        style="font-family: 'Orbitron'; font-size: 2rem; margin: 5px 0; color: white;">
                        LOYAL SUBJECT</h2>

                    <!-- CONSOLIDATED KNEELING BUTTON -->
                    <div id="btn" class="mob-kneel-bar"
                        style="height: 40px; width: 200px; cursor: pointer; border-radius: 10px; overflow: hidden; position: relative; background: rgba(0,0,0,0.4); border: 1px solid var(--gold); margin: 10px 0;"
                        onmousedown="window.handleHoldStart(event)" onmouseup="window.handleHoldEnd(event)"
                        onmouseleave="window.handleHoldEnd(event)" ontouchstart="window.handleHoldStart(event)"
                        ontouchend="window.handleHoldEnd(event)">
                        <div id="fill" class="mob-bar-fill"
                            style="width: 0%; background: var(--gold); height: 100%; position: absolute; left: 0; top: 0; transition: width 0.3s ease;">
                        </div>
                        <div class="mob-bar-content"
                            style="position: relative; z-index: 1; height: 100%; display: flex; align-items: center; justify-content: center; width: 100%; gap: 10px;">
                            <span id="txt-main"
                                style="font-family: 'Orbitron'; font-size: 0.7rem; color: white; text-shadow: 0 1px 3px black;">HOLD
                                TO KNEEL</span>
                        </div>
                    </div>

                    <p
                        style="color: var(--gold); font-family: 'Cinzel'; font-size: 0.9rem; letter-spacing: 1px; margin: 5px 0;">
                        "Your devotion determines your destiny."</p>
                </div>
            </div>

            <!-- ACTION PANEL: TASK SYSTEM -->
            <div id="taskActionPanel" class="v-card v-span-2"
                style="display: flex; flex-direction: column; justify-content: space-between; gap: 10px; min-height: 200px;">
                <div class="ribbon-label">CURRENT ORDERS</div>

                <!-- IDLE STATE -->
                <div id="mainButtonsArea"
                    style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px;">
                    <div id="idleMessage"
                        style="font-family: 'Cinzel'; font-size: 0.8rem; color: rgba(255,255,255,0.5); text-align: center;">
                        Awaiting direct orders from the Void...</div>
                    <button id="newTaskBtn" onclick="window.getRandomTask()" class="action-btn"
                        style="width: 100%; border-radius: 12px; background: var(--blue-accent); color: white; padding: 15px; font-weight: bold; letter-spacing: 2px;">REQUEST
                        TASK</button>
                </div>

                <!-- ACTIVE STATE -->
                <div id="activeTaskContent" style="flex-grow: 1; display: flex; flex-direction: column; gap: 10px;">
                    <h2 id="readyText"
                        style="font-family: 'Cinzel'; font-size: 1.1rem; text-align: center; margin: 0; line-height: 1.4; min-height: 60px; display: flex; align-items: center; justify-content: center; color: white;">
                        -</h2>

                    <div id="activeTimerRow" class="hidden" style="display: flex; justify-content: center;">
                        <div class="timer-box-wrapper" style="gap: 10px; display: flex; align-items: center;">
                            <div id="timerH" class="t-box"
                                style="width: 50px; height: 50px; font-size: 1.5rem; border-radius: 10px; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-family: 'Orbitron';">
                                00</div>
                            <div class="t-sep" style="font-size: 1.5rem; color: var(--gold);">:</div>
                            <div id="timerM" class="t-box"
                                style="width: 50px; height: 50px; font-size: 1.5rem; border-radius: 10px; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-family: 'Orbitron';">
                                00</div>
                            <div class="t-sep" style="font-size: 1.5rem; color: var(--gold);">:</div>
                            <div id="timerS" class="t-box"
                                style="width: 50px; height: 50px; font-size: 1.5rem; border-radius: 10px; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-family: 'Orbitron';">
                                00</div>
                        </div>
                    </div>

                    <div id="uploadBtnContainer" class="hidden"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="file" id="evidenceInput" accept="image/*,video/*" class="hidden"
                            onchange="window.handleUploadStart(this)">
                        <button id="btnUpload" onclick="document.getElementById('evidenceInput').click()"
                            class="action-btn"
                            style="background: var(--gold); color: black; border-radius: 10px; font-weight: bold;">UPLOAD</button>
                        <button id="btnSkip" onclick="window.cancelPendingTask()" class="action-btn"
                            style="background: rgba(255,0,60,0.1); color: var(--neon-red); border: 1px solid var(--neon-red); border-radius: 10px; font-size: 0.8rem;">SKIP
                            (-300)</button>
                    </div>
                </div>
            </div>

            <!-- MAIN VIEW STAGE -->
            <div class="v-span-4" style="display: grid; grid-template-columns: 1fr 350px; gap: 25px;">

                <!-- LEFT MAIN COLUMN -->
                <div style="display: flex; flex-direction: column; gap: 25px;">

                    <!-- CONSOLE / CHAT AREA -->
                    <div id="viewServingTop" class="v-card"
                        style="flex-grow: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden; min-height: 0; height: 100%; border-radius: 20px;">

                        <!-- CHAT INTERNAL -->

                        <!-- CHAT INTERNAL -->
                        <div id="chatCard" class="chat-container"
                            style="flex: 1; min-height: 0; background: transparent; margin: 0; border: none; border-radius: 0; display: flex; flex-direction: column;">
                            <div id="chatBox" class="chat-body-frame"
                                style="background: transparent; flex: 1; min-height: 0; overflow-y: auto;">
                                <div id="chatContent" class="chat-area" style="padding: 20px;"></div>
                            </div>
                            <div class="chat-footer"
                                style="background: rgba(255,255,255,0.03); border-top: 1px solid rgba(255,255,255,0.1); padding: 15px; display: flex; align-items: center; gap: 10px;">

                                <div class="chat-input-wrapper"
                                    style="flex-grow: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px;">
                                    <button id="btnMediaPlus" class="chat-btn-plus" onclick="window.handleMediaPlus()"
                                        style="background: var(--blue-accent);">+</button>
                                    <input type="text" id="chatMsgInput" class="chat-input"
                                        placeholder="Communicate with the Void..." onkeypress="handleChatKey(event)">
                                </div>
                                <button class="chat-btn-send" onclick="sendChatMessage()"
                                    style="background: var(--gold); border-radius: 15px; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;">></button>
                            </div>
                        </div>
                    </div>

                    <!-- RECORDS VIEW (ALTERNATE TAB) -->
                    <div id="historySection" class="view-wrapper hidden"
                        style="background: transparent; height: auto; min-height: 500px;">
                        <div class="v-card" style="margin-bottom: 20px;">
                            <h2 style="font-family: 'Cinzel'; color: var(--gold); text-align: center;">SERVICE RECORD
                            </h2>
                        </div>

                        <!-- NEW: STATS SUMMARY INSIDE RECORDS -->
                        <div
                            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                            <div class="v-card" style="padding: 15px; text-align: center;">
                                <div class="ribbon-label">TOTAL TASKS</div>
                                <div id="statTotal" style="font-size: 1.5rem; font-family: 'Orbitron'; color: white;">0
                                </div>
                            </div>
                            <div class="v-card" style="padding: 15px; text-align: center;">
                                <div class="ribbon-label">SKIPPED</div>
                                <div id="statSkipped"
                                    style="font-size: 1.5rem; font-family: 'Orbitron'; color: var(--neon-red);">0</div>
                            </div>
                            <div class="v-card" style="padding: 15px; text-align: center;">
                                <div class="ribbon-label">KNEELS</div>
                                <div id="statTotalKneels"
                                    style="font-size: 1.5rem; font-family: 'Orbitron'; color: var(--neon-green);">0
                                </div>
                            </div>
                        </div>

                        <!-- TRACKS -->
                        <div class="v-card" style="padding: 10px; margin-bottom: 20px;">
                            <div class="ribbon-label" style="padding: 10px;">ACCEPTED OFFERINGS</div>
                            <div id="gridOkay" class="horizontal-scroll-track"
                                style="height: 180px; padding-bottom: 10px;">
                            </div>
                        </div>
                        <div class="v-card" style="padding: 10px; margin-bottom: 20px;">
                            <div class="ribbon-label" style="padding: 10px;">PENDING VERDICT</div>
                            <div id="gridPending" class="horizontal-scroll-track"
                                style="height: 180px; padding-bottom: 10px;"></div>
                        </div>
                        <div class="v-card" style="padding: 10px;">
                            <div class="ribbon-label" style="padding: 10px;">DENIED / VOIDED</div>
                            <div id="gridFailed" class="horizontal-scroll-track"
                                style="height: 180px; padding-bottom: 10px;"></div>
                        </div>
                    </div>

                    <!-- OTHER VIEWS -->
                    <div id="viewBuy" class="view-wrapper hidden" style="padding: 0;">
                        <div class="v-card">
                            <h2
                                style="text-align: center; color: var(--gold); font-family:'Cinzel'; margin-bottom: 25px;">
                                EXCHEQUER</h2>
                            <div class="store-grid" style="grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                <div class="v-card store-item" style="background: rgba(255,255,255,0.03);">
                                    <div style="font-size: 1.2rem; margin-bottom: 10px;">1,000 ü™ô</div>
                                    <button class="action-btn" onclick="buyRealCoins(1000)"
                                        style="font-size: 0.8rem; background: var(--blue-accent); color: white; border: none;">‚Ç¨10.00</button>
                                </div>
                                <div class="v-card store-item" style="background: rgba(255,255,255,0.03);">
                                    <div style="font-size: 1.2rem; margin-bottom: 10px;">5,500 ü™ô</div>
                                    <button class="action-btn" onclick="buyRealCoins(5500)"
                                        style="font-size: 0.8rem; background: var(--blue-accent); color: white; border: none;">‚Ç¨50.00</button>
                                </div>
                                <div class="v-card store-item" style="background: rgba(255,255,255,0.03);">
                                    <div style="font-size: 1.2rem; margin-bottom: 10px;">12,000 ü™ô</div>
                                    <button class="action-btn" onclick="buyRealCoins(12000)"
                                        style="font-size: 0.8rem; background: var(--blue-accent); color: white; border: none;">‚Ç¨100.00</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="viewNews" class="view-wrapper hidden" style="padding: 0;">
                        <div class="v-card">
                            <h2
                                style="font-family:'Cinzel'; color: var(--gold); text-align: center; margin-bottom: 20px;">
                                LIBRARY</h2>
                            <div id="newsGrid" class="gallery-grid"
                                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;"></div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT SIDEBAR (STATS & STORE) -->
                <div style="display:flex; flex-direction:column; gap:25px;">

                    <!-- DAILY DISCIPLINE (MERGED FROM MOBILE) -->
                    <div class="v-card">
                        <div class="ribbon-label" style="margin-bottom: 15px;">DAILY DISCIPLINE</div>
                        <div id="shelfRanks" class="mob-streak-strip" style="justify-content: center; gap: 8px;"></div>
                        <div
                            style="text-align: center; margin-top: 15px; font-size: 0.7rem; color: rgba(255,255,255,0.5); font-family: 'Cinzel';">
                            SINCE <span id="slaveSinceDate" style="color: white;">--/--/--</span>
                        </div>
                    </div>

                    <!-- TRIBUTE STORE (COMPACT) -->
                    <div class="v-card" style="flex-grow: 1;">
                        <div class="ribbon-label" style="margin-bottom: 15px;">TRIBUTE STORE</div>
                        <div id="huntStoreGrid" class="store-grid"
                            style="grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 400px; overflow-y: auto;">
                            <!-- Items will be injected here -->
                        </div>
                        <button class="action-btn" onclick="toggleTributeHunt()"
                            style="margin-top: 20px; font-size: 0.7rem; background: rgba(255,255,255,0.05);">VIEW FULL
                            STORE</button>
                    </div>

                    <!-- PROTOCOL STATUS -->
                    <div class="v-card">
                        <div class="ribbon-label">PROTOCOL ACTIVE</div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <div
                                style="width: 12px; height: 12px; border-radius: 50%; background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green);">
                            </div>
                            <div style="font-family: 'Orbitron'; font-size: 0.9rem;">SILENCE ENGAGED</div>
                        </div>
                    </div>

                </div>

            </div>
        </div>

        <!-- SHARED MODALS & OVERLAYS (STILL NEEDED) -->
        <div id="taskDetailPanel" class="task-detail-panel"
            style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; border-radius: 20px; box-shadow: 0 0 100px rgba(0,0,0,0.8);">
            <!-- Content same as before but restyled -->
            <div class="detail-content" style="text-align: center;">
                <div class="ribbon-label" style="margin-bottom: 15px;">CURRENT ORDERS</div>
                <h2 id="readyText" class="drawer-task-text"
                    style="font-family: 'Cinzel'; font-size: 1.2rem; line-height: 1.6;">-</h2>
                <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="window.toggleTaskDetails(false)" class="action-btn">BACK</button>
                    <button id="btnSkip" onclick="window.cancelPendingTask()" class="text-btn"
                        style="color: var(--neon-red);">SKIP TASK</button>
                </div>
            </div>
        </div>

        <div id="glassModal" class="glass-modal">
            <div id="modalMediaContainer" class="modal-bg-photo"></div>
            <div id="modalGlassOverlay" class="modal-glass-overlay">
                <div id="modalCloseX" onclick="closeModal(null)"
                    style="position:absolute; top:20px; right:20px; font-size:2rem; cursor:pointer; color:white; z-index:110;">
                    √ó</div>
                <!-- Rest of the modal content as before -->
                <div class="theater-content dossier-layout">...</div>
            </div>
        </div>

        <div id="kneelRewardOverlay" class="mob-reward-overlay hidden">
            <div class="mob-reward-card">
                <div class="mob-hex-wrap small-reward">
                    <div class="mob-rank-stamp" style="right: auto; left: -5px; color: #fff; border-color: #fff;">
                        AUTHORIZED</div>
                </div>
                <h2 class="mob-reward-title" style="color: #c5a059; font-family: 'Cinzel'; letter-spacing: 2px;">
                    DEVOTION RECOGNIZED</h2>
                <div class="mob-reward-actions"
                    style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px; width: 100%;">
                    <button onclick="window.claimKneelReward('coins')" class="mob-action-btn"
                        style="border-color: #ffd700; color: #ffd700;">CLAIM COINS</button>
                    <button onclick="window.claimKneelReward('points')" class="mob-action-btn"
                        style="border-color: #fff; color: #fff;">CLAIM MERIT</button>
                </div>
            </div>
        </div>

    </div> <!-- END DESKTOP_APP -->

    <!-- üü¢ MOBILE UNIVERSE (FULL CODE - REORDERED) -->
    <div id="MOBILE_APP" style="display:none;">

        <!-- =======================================================
         DASHBOARD CONTAINER
         ======================================================= -->
        <div id="viewMobileHome"
            style="position: fixed; top: 0; left: 0; width: 100vw; max-width: 100vw; height: 100dvh; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; display: block; padding: 0; z-index: 1; background: transparent;">

            <div class="mob-hud-row">
                <div class="hud-circle slave" onclick="openLobby()">
                    <img src="https://static.wixstatic.com/media/ce3e5b_e06c7a2254d848a480eb98107c35e246~mv2.png">
                    <div class="hud-gear">‚öô</div>
                </div>
                <div class="hud-circle queen" onclick="openQueenMenu()">
                    <img id="hudSlavePic" src="">
                    <div id="hudDomStatus" class="hud-status-dot offline"></div>
                </div>
            </div>



            <!-- === POPUP OVERLAYS (ALL 5 RESTORED) === -->

            <!-- 1. LOBBY -->
            <div id="lobbyOverlay" class="mob-reward-overlay hidden">
                <div class="mob-reward-card lobby-card">
                    <div id="lobbyMenu" class="lobby-content">
                        <button class="lobby-btn" onclick="showLobbyAction('name')">ADD YOUR NAME</button>
                        <button class="lobby-btn" onclick="showLobbyAction('photo')">UPLOAD PHOTO</button>
                        <button class="lobby-btn" onclick="showLobbyAction('routine')">GET ROUTINE</button>
                        <button class="lobby-btn" onclick="showLobbyAction('kinks')">ADD KINKS</button>
                        <button class="lobby-btn" onclick="showLobbyAction('limits')">ADD LIMITS</button>
                        <div class="lobby-divider"></div>
                        <button class="lobby-btn close" onclick="closeLobby()">CLOSE</button>
                    </div>
                    <div id="lobbyActionView" class="lobby-content hidden">
                        <div id="lobbyPrompt" class="lobby-prompt">...</div>
                        <input type="text" id="lobbyInputText" class="lobby-input hidden" placeholder="Type here...">
                        <button id="lobbyInputFileBtn" class="lobby-file-btn hidden"
                            onclick="document.getElementById('lobbyFile').click()">PICK PHOTO</button>
                        <input type="file" id="lobbyFile" hidden
                            onchange="document.getElementById('lobbyInputFileBtn').innerText = 'PHOTO UPLOADED'">
                        <div id="routineSelectionArea" class="hidden"
                            style="width:100%; display:flex; flex-direction:column; gap:10px;">
                            <div class="routine-grid">
                                <div class="routine-tile" onclick="selectRoutineItem(this, 'Morning Kneel')">Morning
                                    Kneel</div>
                                <div class="routine-tile" onclick="selectRoutineItem(this, 'Chastity Check')">Chastity
                                    Check</div>
                                <div class="routine-tile" onclick="selectRoutineItem(this, 'Cleanliness Check')">
                                    Cleanliness Check</div>
                                <div class="routine-tile special" onclick="selectRoutineItem(this, 'custom')">CREATE OWN
                                    (+1000)</div>
                            </div>
                            <input type="text" id="routineCustomInput" class="lobby-input hidden"
                                placeholder="Describe..." style="margin-top:10px;">
                        </div>
                        <div id="kinkSelectionArea" class="hidden" style="width:100%;">
                            <div id="kinkGrid" class="routine-grid"></div>
                        </div>
                        <div class="lobby-cost-area"><span class="cost-lbl">COST:</span><span id="lobbyCostDisplay"
                                class="cost-val">0</span></div>
                        <button id="btnLobbyConfirm" class="lobby-btn gold"
                            onclick="confirmLobbyAction()">SUBMIT</button>
                        <button class="lobby-btn close" onclick="backToLobbyMenu()">BACK</button>
                    </div>
                </div>
            </div>



            <!-- 3. POVERTY -->
            <div id="povertyOverlay" class="mob-reward-overlay hidden">
                <div class="mob-reward-card" style="border-color: #ff003c; box-shadow: 0 0 30px rgba(255, 0, 60, 0.2);">
                    <div class="mob-hex-wrap small-reward" style="background: linear-gradient(135deg, #ff003c, #000);">
                        <div class="mob-rank-stamp" style="right: auto; left: -5px; color: #fff; border-color: #fff;">
                            DENIED</div>
                    </div>
                    <h2 class="mob-reward-title" style="color:#ff003c;">INSUFFICIENT CAPITAL</h2>
                    <div id="povertyInsult"
                        style="font-family:'Cinzel'; color:#ccc; font-size:0.85rem; line-height:1.4; padding:0 10px;">
                        "You cannot afford my attention."</div>
                    <div class="mob-reward-actions" style="margin-top:10px;">
                        <button onclick="goToExchequer()" class="mob-action-btn"
                            style="border-color: #ff003c; color: #ff003c;">BOOST WALLET</button>
                        <button onclick="closePoverty()" class="mob-action-btn"
                            style="border-color: #444; color: #888;">APOLOGIZE & RETURN</button>
                    </div>
                </div>
            </div>

            <!-- 4. KNEEL REWARD (RESTORED) -->
            <div id="mobKneelReward" class="mob-reward-overlay hidden">
                <div class="mob-reward-card">
                    <div class="mob-hex-wrap small-reward">
                        <div class="mob-rank-stamp" style="right: auto; left: -5px; color: #fff; border-color: #fff;">
                            AUTHORIZED</div>
                    </div>
                    <h2 class="mob-reward-title" style="color: #c5a059; font-family: 'Cinzel'; letter-spacing: 2px;">
                        DEVOTION RECOGNIZED</h2>
                    <div class="mob-reward-actions"
                        style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px; width: 100%;">
                        <button onclick="window.claimKneelReward('coins')" class="mob-action-btn"
                            style="border-color: #ffd700; color: #ffd700;">CLAIM COINS</button>
                        <button onclick="window.claimKneelReward('points')" class="mob-action-btn"
                            style="border-color: #fff; color: #fff;">CLAIM MERIT</button>
                    </div>
                </div>
            </div>

            <!-- 5. TROPHY DETAILS -->
            <div id="rewardCardOverlay" class="mob-reward-overlay hidden" onclick="closeRewardCard()">
                <div class="mob-reward-card" onclick="event.stopPropagation()">
                    <div class="rc-header">
                        <div id="rcIcon" class="rc-icon-large"></div>
                        <div class="rc-meta">
                            <div id="rcTitle" class="rc-title">TITLE</div>
                            <div id="rcStatus" class="rc-status">LOCKED</div>
                        </div>
                    </div>
                    <div id="rcQuote" class="rc-quote">...</div>
                    <div class="rc-progress-wrap">
                        <div class="rc-progress-labels"><span id="rcCurrent">0</span><span id="rcTarget">/ 100</span>
                        </div>
                        <div class="rc-track">
                            <div id="rcFill" class="rc-fill"></div>
                        </div>
                    </div>
                    <button class="mob-action-btn" onclick="closeRewardCard()">ACKNOWLEDGE</button>
                </div>
            </div>

            <!-- *** THE MAIN SCROLL *** -->
            <div id="mobHomeScroll"
                style="width: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px 5px 10px 5px; box-sizing: border-box;">

                <!-- 1. TOP BLOCK (HALO + KNEEL) -->
                <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
                    <div class="halo-section">
                        <div class="halo-ring">
                            <div id="mob_slaveName" class="halo-name">SLAVE</div>
                            <div id="mob_rankStamp" class="halo-rank">INITIATE</div>
                            <div class="mob-section-wrapper" style="width:100%;">
                                <div class="mob-grid-label-center">DAILY PROGRESS</div>
                                <div id="mob_streakGrid" class="mob-streak-strip"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div style="width:100%; display:flex; flex-direction:column; align-items:center; z-index:3;">
                        <div class="halo-stats-card">
                            <div class="h-stat"><span class="h-val" id="mobPoints">0</span><span
                                    class="h-lbl">MERIT</span></div>
                            <div class="h-divider"></div>
                            <div class="h-stat"><span class="h-val" id="mobCoins">0</span><span class="h-lbl">NET</span>
                            </div>
                        </div>

                        <div class="mob-stats-toggle-btn" onclick="toggleMobileStats()">
                            SLAVE STATS <span id="mobStatsArrow">‚ñº</span>
                        </div>

                        <div id="mobStatsContent" class="mob-internal-drawer">

                            <!-- 1. WHO YOU ARE (Current) -->
                            <div
                                style="width:100%; text-align:center; padding-bottom:15px; border-bottom:1px solid #333; margin-bottom:15px;">
                                <div style="font-family:'Cinzel'; font-size:0.6rem; color:#666; letter-spacing:2px;">
                                    CURRENT CLASSIFICATION</div>
                                <!-- Matches your Gold/White aesthetic -->
                                <div id="drawer_CurrentRank"
                                    style="font-family:'Cinzel'; font-size:1.2rem; color:#fff; margin:5px 0; text-transform:uppercase;">
                                    LOADING...</div>
                                <div id="drawer_CurrentBenefits"
                                    style="font-family:'Cinzel'; font-size:0.65rem; color:#888; font-style:italic; padding:0 10px; line-height:1.4;">
                                </div>
                            </div>

                            <!-- 2. THE GOAL (Next Rank) -->
                            <div style="width:100%; text-align:center; margin-bottom:15px;">
                                <div
                                    style="font-family:'Orbitron'; font-size:0.6rem; color:#c5a059; letter-spacing:2px;">
                                    WORKING ON PROMOTION TO</div>
                                <!-- Big Gold Text for the Target -->
                                <div id="drawer_NextRank"
                                    style="font-family:'Orbitron'; font-size:1.4rem; color:#c5a059; font-weight:900; letter-spacing:1px; margin-top:5px; text-shadow:0 0 15px rgba(197, 160, 89, 0.3); text-transform:uppercase;">
                                    LOADING...
                                </div>
                            </div>

                            <!-- 3. THE MATH (Progress Bars) -->
                            <!-- JS will inject the Green/Red bars here, exactly like the old card -->
                            <div id="drawer_ProgressContainer"
                                style="width:100%; background:rgba(255,255,255,0.02); border:1px solid #333; border-radius:4px; padding:15px; margin-bottom:20px;">
                                <!-- Bars go here automatically via JS -->
                            </div>

                            <!-- 4. THE PRIZE (Next Benefits) -->
                            <div style="width:100%; text-align:left; padding:0 5px;">
                                <div
                                    style="font-family:'Orbitron'; font-size:0.6rem; color:#c5a059; margin-bottom:8px;">
                                    PRIVILEGES GRANTED</div>
                                <ul id="drawer_NextBenefits"
                                    style="color:#ccc; font-size:0.75rem; font-family:'Cinzel'; padding-left:20px; line-height:1.6; margin:0;">
                                    <!-- JS will fill list items here -->
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Kneel Button -->
                    <div class="halo-stack" style="padding: 0 20px; width:100%; margin-top:15px; margin-bottom: 30px;">
                        <div class="mob-kneel-bar mob-kneel-zone"
                            onmousedown="if(window.handleHoldStart) window.handleHoldStart(event)"
                            onmouseup="if(window.handleHoldEnd) window.handleHoldEnd(event)"
                            onmouseleave="if(window.handleHoldEnd) window.handleHoldEnd(event)"
                            ontouchstart="if(window.handleHoldStart) window.handleHoldStart(event)"
                            ontouchend="if(window.handleHoldEnd) window.handleHoldEnd(event)">
                            <div id="mob_kneelFill" class="mob-bar-fill"></div>
                            <div class="mob-bar-content">
                                <span class="kneel-icon-sm">‚óà</span>
                                <span id="mob_kneelText" class="kneel-text kneel-label">HOLD TO KNEEL</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CHAT SECTION: HEADER -> TICKER -> TOGGLE -->
                <div id="mobChatSection" style="
                width: 100%;
                margin: 0;
                background: #000;
                border-top: 1px solid #333;
                border-bottom: 1px solid #333;
                display: flex;
                flex-direction: column;
            ">

                    <!-- 1. HEADER (Static - Always Visible) -->
                    <div style="
                    padding: 10px 20px;
                    display: flex; align-items: center; gap: 15px;
                    background: linear-gradient(180deg, #111 0%, #050505 100%);
                ">
                        <div style="position: relative; width: 45px; height: 45px;">
                            <img src="https://static.wixstatic.com/media/ce3e5b_19faff471a434690b7a40aacf5bf42c4~mv2.png"
                                style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 1px solid #c5a059;">
                            <div id="mobChatOnlineDot" class="status-dot online"
                                style="position: absolute; bottom: 0; right: 0;"></div>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <div style="font-family: 'Cinzel'; font-weight: 700; font-size: 1rem; color: #fff;">QUEEN
                                KARIN</div>
                            <div id="mobChatStatusText"
                                style="font-family: 'Orbitron'; font-size: 0.55rem; color: #888;">ONLINE</div>
                        </div>
                    </div>

                    <!-- 2. SERVICE MESSAGE (Static - Always Visible) -->
                    <!-- Moved OUT of the hidden panel so it sits between Header and Trigger -->
                    <div id="mob_systemTicker" class="system-ticker" style="
                    width: 100%;
                    padding: 6px 0;
                    background: #080808;
                    border-top: 1px solid #222;
                    border-bottom: 1px solid #222;
                    color: #c5a059;
                    font-family: 'Orbitron';
                    font-size: 0.6rem;
                    text-align: center;
                    letter-spacing: 2px;
                ">SYSTEM ONLINE</div>

                    <!-- 3. THE SWAP ZONE (Button vs Chat) -->

                    <!-- A. THE BUTTON (Default View) -->
                    <div id="btnEnterChatPanel" onclick="window.toggleMobileChat(true)" style="
                    width: 100%;
                    padding: 12px;
                    text-align: center;
                    background: #000;
                    color: #666;
                    font-family: 'Orbitron';
                    font-size: 0.7rem;
                    letter-spacing: 3px;
                    cursor: pointer;
                    transition: 0.2s;
                ">
                        ‚ñº ENTER CHAT
                    </div>

                    <!-- B. THE CHAT BOX (Hidden View) -->
                    <div id="inlineChatPanel" class="hidden" style="

                    width: 100%; height: 450px; background: #050505;
                    display: flex; flex-direction: column;
                    position: relative;
                ">
                        <!-- Messages Area -->
                        <div id="mob_chatBox" class="chat-body-frame" style="
                        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                        padding-bottom: 70px; overflow-y: auto; -webkit-overflow-scrolling: touch;
                    ">
                            <!-- Tribute Overlay (Inside Chat) -->
                            <div id="tributeHuntOverlay" class="hidden overlay-center"
                                style="position: absolute; inset: 0; background: rgba(0,0,0,0.98); z-index: 50; flex-direction: column; padding: 20px;">
                                <div
                                    style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                                    <span style="font-family:'Cinzel'; color:#c5a059;">TRIBUTE STORE</span>
                                    <button onclick="toggleTributeHunt()"
                                        style="color: white; background:none; border:none; cursor:pointer; font-family:'Orbitron'; font-size:1.2rem;">X</button>
                                </div>
                                <div id="huntStoreGrid" class="store-grid"
                                    style="width: 100%; overflow-y: auto; display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
                                </div>
                            </div>

                            <div id="mob_chatContent" class="chat-area"></div>
                        </div>

                        <!-- Close Bar (Optional, to collapse it back) -->
                        <div onclick="window.toggleMobileChat(false)" style="
                        position: absolute; top: 0; right: 10px; z-index: 25;
                        color: #333; font-size: 1.5rem; cursor: pointer;
                    ">√ó</div>

                        <!-- Input Footer -->
                        <div class="chat-footer"
                            style="position: absolute; bottom: 0; width: 100%; height: 65px; z-index: 20; background:#080808; border-top: 1px solid #222;">
                            <div class="chat-input-wrapper">
                                <button id="btnMediaPlus" class="chat-btn-plus"
                                    onclick="window.handleMediaPlus()">+</button>
                                <input type="text" id="mob_chatMsgInput" class="chat-input" placeholder="Transmit..."
                                    onkeypress="handleChatKey(event)">
                            </div>
                            <button class="chat-btn-tribute" onclick="window.toggleTributeHunt()">üéÅ</button>
                            <button class="chat-btn-send" onclick="sendChatMessage()">></button>
                            <input type="file" id="chatMediaInput" class="hidden"
                                onchange="window.handleAdminUpload(this)">
                        </div>
                    </div>

                </div>

                <!-- 5. CURRENT STATUS (LABOR CARD - FIXED TEXT RENDERING) -->
                <div style="width:100%;">
                    <div class="duty-label">CURRENT STATUS</div>
                    <div class="luxury-card" style="padding: 15px 5px;">

                        <!-- IDLE STATE -->
                        <div id="qm_TaskIdle" class="hidden" style="text-align:center;">
                            <div class="txt-status-red" style="margin-bottom:10px;">UNPRODUCTIVE</div>
                            <button class="lobby-btn" style="width:100%; border-color:#c5a059; color:#c5a059;"
                                onclick="window.mobileRequestTask()">
                                REQUEST TASK
                            </button>
                        </div>

                        <!-- WORKING STATE -->
                        <div id="qm_TaskActive" class="hidden" style="text-align:center;">
                            <div class="txt-status-green" style="margin-bottom:5px;">WORKING</div>

                            <!-- 
                           TASK TEXT FIX:
                           Added 'flex-direction: column;' 
                           This stops the text from splitting into side-by-side fields.
                        -->
                            <div id="mobTaskText" style="
                            margin-bottom:10px; min-height:40px; 
                            display:flex; 
                            flex-direction: column; /* <--- THE FIX */
                            align-items:center; justify-content:center; 
                            text-align:center; line-height:1.3;
                            border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;
                        ">
                                LOADING ORDER...
                            </div>

                            <!-- TIMER -->
                            <div class="card-timer-row">
                                <div id="qm_timerH" class="card-t-box">00</div>:
                                <div id="qm_timerM" class="card-t-box">00</div>:
                                <div id="qm_timerS" class="card-t-box">00</div>
                            </div>

                            <!-- ACTIONS -->
                            <div style="display:flex; gap:5px; margin-top:10px;">
                                <button id="mobBtnUpload" class="btn-upload-sm" style="flex:1;"
                                    onclick="document.getElementById('evidenceInputMob').click()">UPLOAD</button>
                                <input type="file" id="evidenceInputMob" hidden
                                    onchange="window.mobileUploadEvidence(this)">
                                <button class="btn-skip-sm" style="flex:1;" onclick="window.mobileSkipTask()">SKIP
                                    (-300)</button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 4. THE ALTAR (PYRAMID) -->
                <div style="width:100%; margin-top: 20px;"
                    onclick="document.getElementById('altarHistoryPanel').classList.toggle('hidden')">
                    <div class="duty-label">THE ALTAR</div>
                    <div class="mob-pyramid-stage" style="height: 240px; cursor:pointer;">
                        <div class="mob-idol side"><img id="mobRec_Slot2" src="">
                            <div class="mob-rank-badge">II</div>
                        </div>
                        <div class="mob-idol side right"><img id="mobRec_Slot3" src="">
                            <div class="mob-rank-badge">III</div>
                        </div>
                        <div class="mob-idol center"><img id="mobRec_Slot1" src="">
                            <div class="mob-rank-badge main">I</div>
                        </div>
                    </div>
                    <div
                        style="text-align:center; font-family:'Cinzel'; font-size:0.6rem; color:#666; margin-top:-10px;">
                        TAP TO REVEAL DATABASE</div>
                </div>

                <div id="altarHistoryPanel" class="hidden" style="width:100%; animation:fadeIn 0.5s;">
                    <div class="mob-grid-label-center"
                        style="text-align: left; padding-left: 10px; color: #666; margin-top: 15px;">ACCEPTED PROTOCOLS
                    </div>
                    <div id="mobRec_Grid" class="mob-horiz-scroll"></div>
                    <div class="mob-grid-label-center"
                        style="text-align: left; padding-left: 10px; color: #ff003c; margin-top: 15px;">FAILED / DENIED
                    </div>
                    <div id="mobRec_Heap" class="mob-horiz-scroll small"></div>
                </div>

                <!-- 5. QUEEN'S WALL (Simple Horizontal Scroll) -->
                <div style="width:100%; margin-top: 20px;">
                    <div class="duty-label">QUEEN'S WALL</div>

                    <!-- The Scroll Track (Visible Immediately) -->
                    <div id="qWall_ScrollTrack" class="mob-horiz-scroll"
                        style="margin-top: 15px; padding-bottom: 10px; min-height: 100px;">
                        <!-- Javascript will fill this with images -->
                        <div style="color:#333; font-size:0.7rem; padding:20px;">LOADING FEED...</div>
                    </div>
                </div>

                <!-- 6. SERVICE RECORD (SPLIT LAYOUT) -->
                <div style="width:100%; margin-top: 20px;">

                    <div class="duty-label">SLAVE RECORDS</div>

                    <!-- PART A: DAILY DISCIPLINE (Stays Visible) -->
                    <div style="width:100%; margin-bottom: 20px;">
                        <div class="duty-label" style="color:#c5a059; border-color:rgba(197, 160, 89, 0.3);">DAILY
                            DISCIPLINE</div>

                        <div style="display:flex; gap:15px; align-items:center;">
                            <!-- THE COUNTER -->
                            <div
                                style="flex: 0 0 90px; height: 90px; display:flex; flex-direction:column; align-items:center; justify-content:center; border:1px solid #c5a059; background:linear-gradient(180deg, #1a1a1a 0%, #000 100%); border-radius:4px; box-shadow: 0 0 15px rgba(197, 160, 89, 0.1);">
                                <div id="dispStreakVal"
                                    style="font-family:'Orbitron'; font-size:2rem; color:#c5a059; line-height:1; text-shadow:0 0 10px rgba(197, 160, 89, 0.3);">
                                    0</div>
                                <div
                                    style="font-family:'Cinzel'; font-size:0.55rem; color:#888; margin-top:5px; letter-spacing:2px;">
                                    STREAK</div>
                            </div>

                            <!-- THE PROOF -->
                            <div id="shelfRoutine" class="mob-horiz-scroll"
                                style="flex:1; height:90px; align-items:center;">
                                <div style="color:#444; font-size:0.6rem; padding:10px; font-family:'Cinzel';">AWAITING
                                    PROOF</div>
                            </div>
                        </div>

                        <div
                            style="text-align:center; font-family:'Cinzel'; font-size:0.6rem; color:#666; margin-top:5px; letter-spacing:1px;">
                            PERSONAL BEST: <span id="dispBestStreak" style="color:#888;">0</span> DAYS
                        </div>
                    </div>

                    <!-- PART B: THE TROPHY JAIL (Modal covers ONLY this part) -->
                    <div id="trophySectionJail"
                        style="position: relative; width: 100%; min-height: 400px; overflow: hidden;">

                        <!-- HIERARCHY -->
                        <div class="mob-grid-label-center" style="text-align: left; padding-left: 10px; color: #666;">
                            HIERARCHY</div>
                        <div id="shelfRanks" class="reward-shelf mob-horiz-scroll"></div>

                        <!-- LABOR -->
                        <div class="mob-grid-label-center"
                            style="text-align: left; padding-left: 10px; color: #666; margin-top: 15px;">LABOR MEDALS
                        </div>
                        <div id="shelfTasks" class="reward-shelf mob-horiz-scroll"></div>

                        <!-- ENDURANCE -->
                        <div class="mob-grid-label-center"
                            style="text-align: left; padding-left: 10px; color: #666; margin-top: 15px;">ENDURANCE</div>
                        <div id="shelfKneel" class="reward-shelf mob-horiz-scroll"></div>

                        <!-- SACRIFICE -->
                        <div class="mob-grid-label-center"
                            style="text-align: left; padding-left: 10px; color: #666; margin-top: 15px;">SACRIFICE</div>
                        <div id="shelfSpend" class="reward-shelf mob-horiz-scroll"></div>

                        <!-- THE MODAL (Moved Inside the Jail) -->
                        <div id="rewardCardOverlay" class="mob-reward-overlay hidden" onclick="closeRewardCard()">
                            <div class="mob-reward-card" onclick="event.stopPropagation()">
                                <!-- JS fills this -->
                            </div>
                        </div>

                    </div>
                </div>

                <!-- (Exchequer kept hidden) -->
                <div id="mobExchequer" class="mob-reward-overlay hidden" style="z-index: 2147483640;">
                    <div class="mob-reward-card lobby-card" style="border: 1px solid #c5a059;">
                        <div class="lobby-header">
                            <div class="lobby-title">EXCHEQUER</div>
                        </div>
                        <div class="coin-grid">
                            <div class="coin-tile" onclick="window.buyRealCoins(1000)">
                                <div class="coin-amount">1,000</div>
                                <div class="coin-price">‚Ç¨10.00</div>
                            </div>
                            <div class="coin-tile" onclick="window.buyRealCoins(5500)">
                                <div class="coin-amount">5,500</div>
                                <div class="coin-price">‚Ç¨50.00</div>
                            </div>
                            <div class="coin-tile" onclick="window.buyRealCoins(12000)">
                                <div class="coin-amount">12,000</div>
                                <div class="coin-price">‚Ç¨100.00</div>
                            </div>
                            <div class="coin-tile" onclick="window.buyRealCoins(30000)">
                                <div class="coin-amount">30,000</div>
                                <div class="coin-price">‚Ç¨250.00</div>
                            </div>
                            <div class="coin-tile" onclick="window.buyRealCoins(70000)">
                                <div class="coin-amount">70,000</div>
                                <div class="coin-price">‚Ç¨500.00</div>
                            </div>
                            <div class="coin-tile" onclick="window.buyRealCoins(150000)">
                                <div class="coin-amount">150,000</div>
                                <div class="coin-price">‚Ç¨1000.00</div>
                            </div>
                        </div>
                        <button class="lobby-btn close" onclick="closeExchequer()"
                            style="margin-top:20px;">CLOSE</button>
                    </div>
                </div>

                <!-- === POPUP OVERLAYS (ALL RESTORED) === -->

                <!-- 1. LOBBY (SETTINGS) -->
                <div id="lobbyOverlay" class="mob-reward-overlay hidden">
                    <div class="mob-reward-card lobby-card">
                        <div id="lobbyMenu" class="lobby-content">
                            <button class="lobby-btn" onclick="showLobbyAction('name')">ADD YOUR NAME</button>
                            <button class="lobby-btn" onclick="showLobbyAction('photo')">UPLOAD PHOTO</button>
                            <button class="lobby-btn" onclick="showLobbyAction('routine')">GET ROUTINE</button>
                            <button class="lobby-btn" onclick="showLobbyAction('kinks')">ADD KINKS</button>
                            <button class="lobby-btn" onclick="showLobbyAction('limits')">ADD LIMITS</button>
                            <div class="lobby-divider"></div>
                            <button class="lobby-btn close" onclick="closeLobby()">CLOSE</button>
                        </div>
                        <div id="lobbyActionView" class="lobby-content hidden">
                            <div id="lobbyPrompt" class="lobby-prompt">...</div>
                            <input type="text" id="lobbyInputText" class="lobby-input hidden"
                                placeholder="Type here...">
                            <button id="lobbyInputFileBtn" class="lobby-file-btn hidden"
                                onclick="document.getElementById('lobbyFile').click()">PICK PHOTO</button>
                            <input type="file" id="lobbyFile" hidden
                                onchange="document.getElementById('lobbyInputFileBtn').innerText = 'PHOTO UPLOADED'">
                            <div id="routineSelectionArea" class="hidden"
                                style="width:100%; display:flex; flex-direction:column; gap:10px;">
                                <div class="routine-grid">
                                    <div class="routine-tile" onclick="selectRoutineItem(this, 'Morning Kneel')">Morning
                                        Kneel</div>
                                    <div class="routine-tile" onclick="selectRoutineItem(this, 'Chastity Check')">
                                        Chastity Check</div>
                                    <div class="routine-tile" onclick="selectRoutineItem(this, 'Cleanliness Check')">
                                        Cleanliness Check</div>
                                    <div class="routine-tile special" onclick="selectRoutineItem(this, 'custom')">CREATE
                                        OWN (+1000)</div>
                                </div>
                                <input type="text" id="routineCustomInput" class="lobby-input hidden"
                                    placeholder="Describe..." style="margin-top:10px;">
                            </div>
                            <div id="kinkSelectionArea" class="hidden" style="width:100%;">
                                <div id="kinkGrid" class="routine-grid"></div>
                            </div>
                            <div class="lobby-cost-area"><span class="cost-lbl">COST:</span><span id="lobbyCostDisplay"
                                    class="cost-val">0</span></div>
                            <button id="btnLobbyConfirm" class="lobby-btn gold"
                                onclick="confirmLobbyAction()">SUBMIT</button>
                            <button class="lobby-btn close" onclick="backToLobbyMenu()">BACK</button>
                        </div>
                    </div>
                </div>

                <!-- 2. QUEEN MENU (DAILY DUTIES) -->
                <div id="queenOverlay" class="mob-reward-overlay hidden">
                    <div class="mob-reward-card queen-card-layout"
                        style="width: 90%; max-height: 80vh; overflow-y: auto;">

                        <!-- HEADER -->
                        <div class="mob-chat-header"
                            style="width:100%; justify-content:space-between; margin-bottom: 20px; background: transparent; border: none; padding: 0;">
                            <div class="chat-queen-name" style="color: #c5a059; font-size: 1.2rem;">DAILY DUTIES</div>
                            <button onclick="closeQueenMenu()"
                                style="background:none; border:none; color:#fff; font-size:2rem; cursor:pointer;">√ó</button>
                        </div>

                        <!-- 1. ROUTINE UPLOAD SECTION -->
                        <div
                            style="width:100%; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 20px;">
                            <div class="duty-label">MANDATORY PROTOCOL</div>

                            <!-- Routine Name (Updated by JS) -->
                            <div id="mobRoutineDisplay"
                                style="color: white; font-family: 'Orbitron'; text-align: center; margin: 15px 0; font-size: 1.1rem; letter-spacing: 2px;">
                                LOADING...
                            </div>

                            <!-- Action Area -->
                            <div style="display:flex; flex-direction: column; align-items:center; gap: 10px;">
                                <!-- Upload Button -->
                                <button id="btnRoutineUpload" class="action-btn"
                                    onclick="document.getElementById('routineUploadInput').click()">
                                    UPLOAD PROOF
                                </button>
                                <input type="file" id="routineUploadInput" class="hidden"
                                    onchange="window.handleRoutineUpload(this)">

                                <!-- Messages (Hidden/Shown by JS) -->
                                <div id="routineTimeMsg" class="hidden"
                                    style="color:#666; font-size:0.7rem; font-style:italic;">
                                    WINDOW CLOSED
                                </div>
                                <div id="routineDoneMsg" class="hidden"
                                    style="color:#00ff00; font-size:0.9rem; font-family:'Orbitron'; text-shadow: 0 0 10px #00ff00;">
                                    ‚úî SUBMITTED
                                </div>
                            </div>
                        </div>

                        <!-- 2. KNEELING COUNTER -->
                        <div
                            style="width:100%; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 20px;">
                            <div class="duty-label">KNEELING HOURS</div>

                            <!-- Progress Bar -->
                            <div class="mob-kneel-bar"
                                style="height: 35px; margin-top: 15px; cursor: default; background: #000; border: 1px solid #444;">
                                <div id="kneelDailyFill" class="mob-bar-fill" style="width: 0%; background: #c5a059;">
                                </div>
                                <div class="mob-bar-content" style="width:100%; justify-content:center;">
                                    <span id="kneelDailyText"
                                        style="font-family:'Orbitron'; font-size:0.9rem; color:#fff; z-index:2;">0 /
                                        8</span>
                                </div>
                            </div>
                        </div>

                        <!-- 3. TASK COUNTERS (Using existing Stats IDs) -->
                        <div style="width:100%;">
                            <div class="duty-label">LABOR COMPLETED</div>

                            <div style="display:flex; justify-content:space-around; margin-top: 15px;">
                                <div style="text-align:center;">
                                    <div style="font-size:0.6rem; color:#888; font-family:'Cinzel'; margin-bottom:5px;">
                                        CURRENT STREAK</div>
                                    <!-- Reuse the ID so JS updates it automatically -->
                                    <div id="mobStreak" style="font-size:1.8rem; color:white; font-family:'Orbitron';">0
                                    </div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.6rem; color:#888; font-family:'Cinzel'; margin-bottom:5px;">
                                        TOTAL SERVED</div>
                                    <!-- Reuse the ID so JS updates it automatically -->
                                    <div id="mobTotal" style="font-size:1.8rem; color:#c5a059; font-family:'Orbitron';">
                                        0</div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 3. POVERTY OVERLAY (RESTORED) -->
                <div id="povertyOverlay" class="mob-reward-overlay hidden">
                    <div class="mob-reward-card"
                        style="border-color: #ff003c; box-shadow: 0 0 30px rgba(255, 0, 60, 0.2);">
                        <div class="mob-hex-wrap small-reward"
                            style="background: linear-gradient(135deg, #ff003c, #000);">
                            <div class="mob-rank-stamp"
                                style="right: auto; left: -5px; color: #fff; border-color: #fff;">DENIED</div>
                        </div>
                        <h2 class="mob-reward-title" style="color:#ff003c;">INSUFFICIENT CAPITAL</h2>
                        <div id="povertyInsult"
                            style="font-family:'Cinzel'; color:#ccc; font-size:0.85rem; line-height:1.4; padding:0 10px;">
                            "You cannot afford my attention."</div>
                        <div class="mob-reward-actions" style="margin-top:10px;">
                            <button onclick="goToExchequer()" class="mob-action-btn"
                                style="border-color: #ff003c; color: #ff003c;">BOOST WALLET</button>
                            <button onclick="closePoverty()" class="mob-action-btn"
                                style="border-color: #444; color: #888;">APOLOGIZE & RETURN</button>
                        </div>
                    </div>
                </div>

                <!-- 4. KNEEL REWARD OVERLAY (RESTORED) -->
                <div id="mobKneelReward" class="mob-reward-overlay hidden">
                    <div class="mob-reward-card">
                        <div class="mob-hex-wrap small-reward">
                            <div class="mob-rank-stamp"
                                style="right: auto; left: -5px; color: #fff; border-color: #fff;">AUTHORIZED</div>
                        </div>
                        <h2 class="mob-reward-title"
                            style="color: #c5a059; font-family: 'Cinzel'; letter-spacing: 2px;">DEVOTION RECOGNIZED</h2>
                        <div class="mob-reward-actions"
                            style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px; width: 100%;">
                            <button onclick="window.claimKneelReward('coins')" class="mob-action-btn"
                                style="border-color: #ffd700; color: #ffd700;">CLAIM COINS</button>
                            <button onclick="window.claimKneelReward('points')" class="mob-action-btn"
                                style="border-color: #fff; color: #fff;">CLAIM MERIT</button>
                        </div>
                    </div>
                </div>

                <!-- 5. REWARD DETAILS (TROPHIES) -->
                <div id="rewardCardOverlay" class="mob-reward-overlay hidden" onclick="closeRewardCard()">
                    <div class="mob-reward-card" onclick="event.stopPropagation()">
                        <div class="rc-header">
                            <div id="rcIcon" class="rc-icon-large"></div>
                            <div class="rc-meta">
                                <div id="rcTitle" class="rc-title">TITLE</div>
                                <div id="rcStatus" class="rc-status">LOCKED</div>
                            </div>
                        </div>
                        <div id="rcQuote" class="rc-quote">...</div>
                        <div class="rc-progress-wrap">
                            <div class="rc-progress-labels"><span id="rcCurrent">0</span><span id="rcTarget">/
                                    100</span></div>
                            <div class="rc-track">
                                <div id="rcFill" class="rc-fill"></div>
                            </div>
                        </div>
                        <button class="mob-action-btn" onclick="closeRewardCard()">ACKNOWLEDGE</button>
                    </div>
                </div>

            </div> <!-- END MOBILE_APP -->


            <script>

                // =========================================
                // IOS VISUAL VIEWPORT RESIZER
                // =========================================
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', () => {
                        // When keyboard opens/closes, browser resizes visualViewport.
                        // We force the body height to match, preventing the "Halfway Scroll" bug.
                        document.body.style.height = window.visualViewport.height + 'px';

                        // Force scroll to top to kill any offsets
                        window.scrollTo(0, 0);
                    });
                }

                function checkDevice() {
                    const isMobile = window.innerWidth <= 768;
                    const desktop = document.getElementById('DESKTOP_APP');
                    const mobile = document.getElementById('MOBILE_APP');
                    const dashboard = document.getElementById('viewMobileHome');

                    if (isMobile) {
                        if (desktop) desktop.style.display = 'none';
                        if (mobile) mobile.style.display = 'flex';
                        // Force Dashboard Visible
                        if (dashboard) {
                            dashboard.style.display = 'flex';
                            dashboard.style.visibility = 'visible';
                            dashboard.style.opacity = '1';
                        }
                    } else {
                        if (mobile) mobile.style.display = 'none';
                        if (desktop) desktop.style.display = 'flex';
                    }
                }
                // Run immediately and on resize
                checkDevice();
                window.addEventListener('resize', checkDevice);
                window.addEventListener('load', checkDevice);
            </script>
            <script type="module">
                import '../profile/kneeling/kneeling.js';
                console.log("Kneeling logic loaded explicitly.");
            </script>
</body>

</html>
